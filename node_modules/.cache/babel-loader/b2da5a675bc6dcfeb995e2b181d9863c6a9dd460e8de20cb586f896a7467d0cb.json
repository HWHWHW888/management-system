{"ast":null,"code":"import _objectSpread from\"/Users/user/Desktop/Cursor New Management System/management-system-1/Junket Management System Source Code/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect,useCallback}from'react';import{Button}from'./ui/button';import{Input}from'./ui/input';import{Label}from'./ui/label';import{Card,CardContent,CardDescription,CardHeader,CardTitle}from'./ui/card';import{Dialog,DialogContent,DialogDescription,DialogHeader,DialogTitle,DialogTrigger}from'./ui/dialog';import{Badge}from'./ui/badge';import{Textarea}from'./ui/textarea';import{Tabs,TabsContent,TabsList,TabsTrigger}from'./ui/tabs';import{Clock,CheckCircle,XCircle,RefreshCw,LogIn,LogOut,Activity,Calendar,MapPin,Users,Camera,DollarSign,Loader2,ChevronUp,ChevronDown}from'lucide-react';import{ImageWithFallback}from'./figma/ImageWithFallback';import{PhotoDisplay}from'./common/PhotoDisplay';import{withErrorHandler}from'./withErrorHandler';import{apiClient}from'../utils/api/apiClient';import{DSContainer,DSHeader,DSButton,DSNotification,iconSizes// Note: Removed unused imports to fix ESLint warnings\n// DSCard, DSBadge, DSFormLayout, spacing, typography, buttonSizes\n}from'./common/DesignSystem';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";function StaffSelfServiceComponent(_ref){let{user,showError,clearError}=_ref;const[currentStaff,setCurrentStaff]=useState(null);const[shifts,setShifts]=useState([]);const[assignedTrips,setAssignedTrips]=useState([]);const[isCheckInDialogOpen,setIsCheckInDialogOpen]=useState(false);const[isCheckOutDialogOpen,setIsCheckOutDialogOpen]=useState(false);const[checkInPhoto,setCheckInPhoto]=useState(null);const[checkOutPhoto,setCheckOutPhoto]=useState(null);const[checkInNotes,setCheckInNotes]=useState('');const[checkOutNotes,setCheckOutNotes]=useState('');const[isLoading,setIsLoading]=useState(true);const[isSaving,setIsSaving]=useState(false);const[selectedTripForUpload,setSelectedTripForUpload]=useState(null);const[tripCustomers,setTripCustomers]=useState([]);const[selectedCustomer,setSelectedCustomer]=useState(null);const[uploadType,setUploadType]=useState('transaction');const[uploadPhoto,setUploadPhoto]=useState(null);const[uploadDate,setUploadDate]=useState(new Date().toISOString().split('T')[0]);// 设置默认日期为当日\nconst[isUploadDialogOpen,setIsUploadDialogOpen]=useState(false);const[,setCustomerTransactions]=useState([]);const[,setCustomerRolling]=useState([]);const[expandedTripId,setExpandedTripId]=useState(null);const[customerPhotos,setCustomerPhotos]=useState([]);const[successMessage,setSuccessMessage]=useState('');// Load staff data and shifts\nconst loadStaffData=useCallback(async()=>{try{setIsLoading(true);clearError();// Use staff_id from user object (user.id is users table ID, user.staff_id is staff table ID)\nconst staffId=user.staff_id||user.id;console.log('Loading staff data for staff ID:',staffId,'User ID:',user.id);// Get current staff info\nconst staffResponse=await apiClient.get(\"/staffs/\".concat(staffId));if(staffResponse.success){setCurrentStaff(staffResponse.data);}// Get staff shifts history\nconst shiftsResponse=await apiClient.get(\"/staffs/\".concat(staffId,\"/shifts\"));if(shiftsResponse.success){setShifts(shiftsResponse.data);}// Get assigned trips (staff can only see their assigned trips)\nconst tripsResponse=await apiClient.get('/trips/my-schedule');if(tripsResponse.success){// Use trip data directly without trying to fetch customer stats\n// Staff will see customer details when they click \"View Customers\"\nconst enrichedTrips=(tripsResponse.data||[]).map(trip=>_objectSpread(_objectSpread({},trip),{},{customers:[],activecustomerscount:trip.activecustomerscount||0}));setAssignedTrips(enrichedTrips);}else{setAssignedTrips([]);}}catch(error){console.error('Error loading staff data:',error);showError('Failed to load staff data');}finally{setIsLoading(false);}},[user,clearError,showError]);useEffect(()=>{loadStaffData();},[loadStaffData]);const getCurrentShift=()=>{return shifts.find(shift=>shift.status==='checked-in');};const isCheckedIn=()=>{return getCurrentShift()!==undefined;};const handleCheckIn=async()=>{if(!checkInPhoto)return;setIsSaving(true);try{// Convert photo to base64\nconst reader=new FileReader();reader.onload=async e=>{try{var _e$target;const photoData=(_e$target=e.target)===null||_e$target===void 0?void 0:_e$target.result;const staffId=user.staff_id||user.id;const response=await apiClient.post(\"/staffs/\".concat(staffId,\"/check-in\"),{check_in_photo:photoData,notes:checkInNotes});if(response.success){setIsCheckInDialogOpen(false);setCheckInPhoto(null);setCheckInNotes('');setSuccessMessage('Check-in successful! You are now on duty.');setTimeout(()=>setSuccessMessage(''),3000);await loadStaffData();// Refresh data\n}else{showError('Check-in failed: '+response.message);}}catch(error){console.error('Check-in error:',error);showError('Check-in failed');}finally{setIsSaving(false);}};reader.readAsDataURL(checkInPhoto);}catch(error){console.error('Check-in error:',error);showError('Check-in failed');setIsSaving(false);}};const handleCheckOut=async()=>{if(!checkOutPhoto)return;setIsSaving(true);try{const reader=new FileReader();reader.onload=async e=>{try{var _e$target2;const photoData=(_e$target2=e.target)===null||_e$target2===void 0?void 0:_e$target2.result;const staffId=user.staff_id||user.id;const response=await apiClient.post(\"/staffs/\".concat(staffId,\"/check-out\"),{check_out_photo:photoData,notes:checkOutNotes});if(response.success){setIsCheckOutDialogOpen(false);setCheckOutPhoto(null);setCheckOutNotes('');setSuccessMessage('Check-out successful! Your shift has ended.');setTimeout(()=>setSuccessMessage(''),3000);await loadStaffData();// Refresh data\n}else{showError('Check-out failed: '+response.message);}}catch(error){console.error('Check-out error:',error);showError('Check-out failed');}finally{setIsSaving(false);}};reader.readAsDataURL(checkOutPhoto);}catch(error){showError('Check-out failed');setIsSaving(false);}};// Load detailed trip data with customers and their transactions/rolling\nconst loadTripDetails=async trip=>{try{// Try multiple approaches to get customer data\nlet customersLoaded=false;// 添加客户数据结构转换函数\nconst normalizeCustomerData=customers=>{return customers.map(customer=>{// 检查所有可能的ID字段\nconst possibleIdFields=['id','customer_id','customerId','ID','Id'];const id=possibleIdFields.map(field=>customer[field]).find(val=>val)||'unknown-id';// 检查所有可能的名字字段\nconst possibleNameFields=['name','customer_name','customerName','full_name','fullName','Name','first_name','firstName','last_name','lastName','display_name','displayName'];let name=possibleNameFields.map(field=>customer[field]).find(val=>val&&val.trim());// 如果还是没有找到名字，尝试从嵌套对象中查找\nif(!name&&customer.customer){name=possibleNameFields.map(field=>customer.customer[field]).find(val=>val&&val.trim());}// 最后的回退策略 - 使用ID作为显示名称\nif(!name){name=\"Customer \".concat(id);}// 返回标准化的客户对象\nreturn _objectSpread(_objectSpread({},customer),{},{id,name,customer_id:id,customer_name:name});});};// Approach 1: Try trip-specific customer stats (recommended)\ntry{const customersResponse=await apiClient.get(\"/trips/\".concat(trip.id,\"/customer-stats\"));if(customersResponse.success){// 应用标准化函数处理客户数据\nconst normalizedCustomers=normalizeCustomerData(customersResponse.data||[]);setTripCustomers(normalizedCustomers);customersLoaded=true;}}catch(error){console.log('Trip-specific customer stats failed, trying trip customers endpoint');}// Approach 2: Try trip customers endpoint (more specific than customer-stats)\nif(!customersLoaded){try{const tripCustomersResponse=await apiClient.get(\"/trips/\".concat(trip.id,\"/customers\"));if(tripCustomersResponse.success){// This should return only customers assigned to this specific trip\nconst normalizedCustomers=normalizeCustomerData(tripCustomersResponse.data||[]);setTripCustomers(normalizedCustomers);customersLoaded=true;}}catch(error){console.log('Trip customers endpoint failed');}}// Approach 3: Use any existing trip data as fallback\nif(!customersLoaded&&trip.customers){const normalizedCustomers=normalizeCustomerData(trip.customers||[]);setTripCustomers(normalizedCustomers);customersLoaded=true;}// Load transactions, rolling records, and customer photos if we have customers\nif(customersLoaded){try{// 加载交易记录和滚码记录（旧API）\nconst[transactionsResponse,rollingResponse]=await Promise.all([apiClient.get(\"/transactions?trip_id=\".concat(trip.id)),apiClient.get(\"/rolling-records?trip_id=\".concat(trip.id))]);console.log('Transactions response:',transactionsResponse);console.log('Rolling response:',rollingResponse);if(transactionsResponse.success){setCustomerTransactions(transactionsResponse.data||[]);}if(rollingResponse.success){setCustomerRolling(rollingResponse.data||[]);}// 尝试加载客户照片（新API）\ntry{const photosResponse=await apiClient.get(\"/customer-photos?trip_id=\".concat(trip.id));console.log('Customer photos response:',photosResponse);if(photosResponse.success){setCustomerPhotos(photosResponse.data||[]);}else{setCustomerPhotos([]);}}catch(error){console.log('Failed to load customer photos (new API may not be implemented yet):',error);setCustomerPhotos([]);}}catch(error){console.log('Failed to load transactions/rolling:',error);setCustomerTransactions([]);setCustomerRolling([]);setCustomerPhotos([]);}}else{// No customers loaded, set empty arrays\nconsole.log('No customers loaded, setting empty arrays');setTripCustomers([]);setCustomerTransactions([]);setCustomerRolling([]);setCustomerPhotos([]);}// Set the selected trip ID for the expandable section\nsetSelectedTripForUpload(trip);}catch(error){console.error('Error loading trip details:',error);showError('Failed to load trip details');// Fallback: use any existing trip data\nif(trip.customers){setTripCustomers(trip.customers);}setCustomerTransactions([]);setCustomerRolling([]);setCustomerPhotos([]);// Close the expanded section on error\nsetExpandedTripId(null);}};// Legacy functions kept for future compatibility (currently unused)\n// const getCustomerTransactions = (customerId: string) => {\n//   return customerTransactions.filter(t => \n//     (t.customer_id === customerId || t.customerId === customerId)\n//   );\n// };\n// const getCustomerRolling = (customerId: string) => {\n//   return customerRolling.filter(r => \n//     (r.customer_id === customerId || r.customerId === customerId)\n//   );\n// };\n// Handle photo deletion\nconst handlePhotoDelete=async photoId=>{setIsSaving(true);try{const response=await apiClient.delete(\"/customer-photos/\".concat(photoId));if(response.success){console.log('✅ Photo deleted successfully:',photoId);// Refresh customer photos - the UI will automatically update to show the photo is gone\nif(selectedTripForUpload){await loadTripDetails(selectedTripForUpload);}}else{// Handle different error types\nconst errorMessage=response.message||'Unknown error occurred';showError('Failed to delete photo: '+errorMessage);}}catch(error){console.error('Photo deletion error:',error);// Handle specific HTTP errors\nif(error.message&&error.message.includes('403')){showError('Permission denied: You do not have permission to delete this photo. Only the uploader or admin can delete photos.');}else if(error.message&&error.message.includes('404')){showError('Photo not found: This photo may have already been deleted.');}else if(error.message&&error.message.includes('401')){showError('Authentication required: Please log in again to delete photos.');}else{showError('Failed to delete photo: '+(error.message||'Network or server error'));}}finally{setIsSaving(false);}};// Handle photo upload for transaction/rolling using customer_photos table\nconst handlePhotoUpload=async()=>{if(!uploadPhoto||!selectedCustomer||!uploadDate){showError('Please fill in all required fields');return;}setIsSaving(true);try{const reader=new FileReader();reader.onload=async e=>{try{var _e$target3,_selectedCustomer$cus,_selectedCustomer$cus2;const photoData=(_e$target3=e.target)===null||_e$target3===void 0?void 0:_e$target3.result;// 使用新的customer_photos表结构，照片存储为JSON格式\nconst photoJson={data:photoData,// 照片数据\nfilename:uploadPhoto.name,// 文件名\nsize:uploadPhoto.size,// 文件大小\ntype:uploadPhoto.type,// 文件类型\nuploaded_at:new Date().toISOString()};const customerPhotoData={customer_id:(_selectedCustomer$cus=selectedCustomer.customer)===null||_selectedCustomer$cus===void 0?void 0:_selectedCustomer$cus.id,trip_id:selectedTripForUpload.id,photo_type:uploadType,// 'transaction' 或 'rolling'\nphoto:photoJson,// 存储为JSON格式\nuploaded_by:user.staff_id||user.id,transaction_date:uploadDate// 交易日期\n// status 字段由数据库默认设置为 'pending'，不需要手动指定\n};// 使用新的API端点\nconst endpoint='/customer-photos';console.log(\"Uploading \".concat(uploadType,\" photo for customer:\"),selectedCustomer.customer_name||selectedCustomer.name);// Debug log for selectedCustomer structure\nconsole.log(\"🔍 Selected Customer Object:\",selectedCustomer);console.log(\"🔍 Customer ID fields:\",{\"selectedCustomer.id\":selectedCustomer.id,\"selectedCustomer.customer_id\":selectedCustomer.customer_id,\"selectedCustomer.customer?.id\":(_selectedCustomer$cus2=selectedCustomer.customer)===null||_selectedCustomer$cus2===void 0?void 0:_selectedCustomer$cus2.id});// Debug log for photo upload payload\nconsole.log(\"📸 Uploading photo payload:\",{customer_id:customerPhotoData.customer_id,trip_id:customerPhotoData.trip_id,photo_type:customerPhotoData.photo_type,photo:customerPhotoData.photo,transaction_date:customerPhotoData.transaction_date});const response=await apiClient.post(endpoint,customerPhotoData);if(response.success){setIsUploadDialogOpen(false);setUploadPhoto(null);setUploadDate(new Date().toISOString().split('T')[0]);// 重置日期为今天\nsetSelectedCustomer(null);// 显示成功消息\nsetSuccessMessage(\"\".concat(uploadType==='transaction'?'Transaction':'Rolling',\" photo uploaded successfully and pending approval\"));// 3秒后自动清除成功消息\nsetTimeout(()=>setSuccessMessage(''),3000);// 刷新客户数据\nawait loadTripDetails(selectedTripForUpload);}else{showError(\"Failed to upload \".concat(uploadType,\" photo: \")+response.message);}}catch(error){console.error(\"\".concat(uploadType,\" photo upload error:\"),error);showError(\"Failed to upload \".concat(uploadType,\" photo\"));}finally{setIsSaving(false);}};reader.readAsDataURL(uploadPhoto);}catch(error){console.error(\"\".concat(uploadType,\" upload error:\"),error);showError(\"Failed to upload \".concat(uploadType));setIsSaving(false);}};if(isLoading){return/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center justify-center h-64\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-600\",children:\"Loading staff information...\"})]})});}const currentShift=getCurrentShift();return/*#__PURE__*/_jsxs(DSContainer,{children:[successMessage&&/*#__PURE__*/_jsx(DSNotification,{type:\"success\",title:\"Success\",message:successMessage,onClose:()=>setSuccessMessage('')}),/*#__PURE__*/_jsx(DSHeader,{title:\"Staff Self-Service\",subtitle:\"Welcome, \".concat((currentStaff===null||currentStaff===void 0?void 0:currentStaff.name)||user.username),badges:[{text:\"Staff ID: \".concat(user.id),variant:'gray'},{text:\"\".concat(assignedTrips.length,\" Assigned Trips\"),variant:'primary'}],actions:/*#__PURE__*/_jsxs(DSButton,{variant:\"outline\",size:\"mobile\",onClick:loadStaffData,disabled:isLoading,icon:/*#__PURE__*/_jsx(RefreshCw,{className:iconSizes.sm}),children:[/*#__PURE__*/_jsx(\"span\",{className:\"hidden sm:inline\",children:\"Refresh\"}),/*#__PURE__*/_jsx(\"span\",{className:\"sm:hidden\",children:\"Refresh Data\"})]})}),/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsx(CardHeader,{className:\"pb-3 sm:pb-6\",children:/*#__PURE__*/_jsxs(CardTitle,{className:\"flex items-center space-x-2 text-base sm:text-lg\",children:[/*#__PURE__*/_jsx(Clock,{className:\"w-4 h-4 sm:w-5 sm:h-5\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Current Status\"})]})}),/*#__PURE__*/_jsx(CardContent,{className:\"pt-0\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex-1 min-w-0\",children:isCheckedIn()?/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col sm:flex-row sm:items-center space-y-1 sm:space-y-0 sm:space-x-2\",children:[/*#__PURE__*/_jsxs(Badge,{className:\"bg-green-100 text-green-800 px-3 py-1 w-fit\",children:[/*#__PURE__*/_jsx(CheckCircle,{className:\"w-3 h-3 sm:w-4 sm:h-4 mr-1\"}),\"On Duty\"]}),/*#__PURE__*/_jsxs(\"span\",{className:\"text-xs sm:text-sm text-gray-600\",children:[\"Since: \",new Date(currentShift.check_in_time).toLocaleString()]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"text-xs text-gray-500\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"sm:inline\",children:[\"Shift Date: \",currentShift.shift_date]}),/*#__PURE__*/_jsxs(\"div\",{className:\"sm:inline sm:ml-2\",children:[\"Duration: \",Math.floor((new Date().getTime()-new Date(currentShift.check_in_time).getTime())/(1000*60)),\" min\"]})]})]}):/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col sm:flex-row sm:items-center space-y-1 sm:space-y-0 sm:space-x-2\",children:[/*#__PURE__*/_jsxs(Badge,{variant:\"secondary\",className:\"px-3 py-1 w-fit\",children:[/*#__PURE__*/_jsx(XCircle,{className:\"w-3 h-3 sm:w-4 sm:h-4 mr-1\"}),\"Off Duty\"]}),/*#__PURE__*/_jsx(\"span\",{className:\"text-xs sm:text-sm text-gray-600\",children:\"Ready to check in\"})]})}),/*#__PURE__*/_jsx(\"div\",{className:\"flex flex-col sm:flex-row gap-2 sm:space-x-2\",children:isCheckedIn()?/*#__PURE__*/_jsxs(Dialog,{open:isCheckOutDialogOpen,onOpenChange:setIsCheckOutDialogOpen,children:[/*#__PURE__*/_jsx(DialogTrigger,{asChild:true,children:/*#__PURE__*/_jsxs(Button,{variant:\"destructive\",disabled:isSaving,className:\"w-full sm:w-auto\",children:[/*#__PURE__*/_jsx(LogOut,{className:\"w-3 h-3 sm:w-4 sm:h-4 mr-2\"}),/*#__PURE__*/_jsx(\"span\",{className:\"hidden sm:inline\",children:\"Check Out\"}),/*#__PURE__*/_jsx(\"span\",{className:\"sm:hidden\",children:\"Check Out\"})]})}),/*#__PURE__*/_jsxs(DialogContent,{children:[/*#__PURE__*/_jsxs(DialogHeader,{children:[/*#__PURE__*/_jsx(DialogTitle,{children:\"Check Out\"}),/*#__PURE__*/_jsx(DialogDescription,{children:\"Upload a photo as proof of check-out and add any end-of-shift notes.\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-4\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{htmlFor:\"checkOutPhoto\",children:\"Check-out Photo (Required)\"}),/*#__PURE__*/_jsx(Input,{id:\"checkOutPhoto\",type:\"file\",accept:\"image/*\",onChange:e=>{var _e$target$files;return setCheckOutPhoto(((_e$target$files=e.target.files)===null||_e$target$files===void 0?void 0:_e$target$files[0])||null);},className:\"mt-1\",required:true,disabled:isSaving})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{htmlFor:\"checkOutNotes\",children:\"End of Shift Notes (Optional)\"}),/*#__PURE__*/_jsx(Textarea,{id:\"checkOutNotes\",value:checkOutNotes,onChange:e=>setCheckOutNotes(e.target.value),placeholder:\"Any end-of-shift notes...\",rows:3,disabled:isSaving})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-end space-x-2\",children:[/*#__PURE__*/_jsx(Button,{type:\"button\",variant:\"outline\",onClick:()=>setIsCheckOutDialogOpen(false),disabled:isSaving,children:\"Cancel\"}),/*#__PURE__*/_jsx(Button,{onClick:handleCheckOut,disabled:!checkOutPhoto||isSaving,children:isSaving?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Activity,{className:\"w-4 h-4 mr-2 animate-spin\"}),\"Saving...\"]}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(LogOut,{className:\"w-4 h-4 mr-2\"}),\"Check Out\"]})})]})]})]})]}):/*#__PURE__*/_jsxs(Dialog,{open:isCheckInDialogOpen,onOpenChange:setIsCheckInDialogOpen,children:[/*#__PURE__*/_jsx(DialogTrigger,{asChild:true,children:/*#__PURE__*/_jsxs(Button,{disabled:isSaving,className:\"w-full sm:w-auto\",children:[/*#__PURE__*/_jsx(LogIn,{className:\"w-3 h-3 sm:w-4 sm:h-4 mr-2\"}),/*#__PURE__*/_jsx(\"span\",{className:\"hidden sm:inline\",children:\"Check In\"}),/*#__PURE__*/_jsx(\"span\",{className:\"sm:hidden\",children:\"Check In\"})]})}),/*#__PURE__*/_jsxs(DialogContent,{children:[/*#__PURE__*/_jsxs(DialogHeader,{children:[/*#__PURE__*/_jsx(DialogTitle,{children:\"Check In\"}),/*#__PURE__*/_jsx(DialogDescription,{children:\"Upload a photo as proof of check-in and add any notes for the shift.\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-4\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{htmlFor:\"checkInPhoto\",children:\"Check-in Photo (Required)\"}),/*#__PURE__*/_jsx(Input,{id:\"checkInPhoto\",type:\"file\",accept:\"image/*\",onChange:e=>{var _e$target$files2;return setCheckInPhoto(((_e$target$files2=e.target.files)===null||_e$target$files2===void 0?void 0:_e$target$files2[0])||null);},className:\"mt-1\",required:true,disabled:isSaving})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{htmlFor:\"checkInNotes\",children:\"Notes (Optional)\"}),/*#__PURE__*/_jsx(Textarea,{id:\"checkInNotes\",value:checkInNotes,onChange:e=>setCheckInNotes(e.target.value),placeholder:\"Any notes for this shift...\",rows:3,disabled:isSaving})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-end space-x-2\",children:[/*#__PURE__*/_jsx(Button,{type:\"button\",variant:\"outline\",onClick:()=>setIsCheckInDialogOpen(false),disabled:isSaving,children:\"Cancel\"}),/*#__PURE__*/_jsx(Button,{onClick:handleCheckIn,disabled:!checkInPhoto||isSaving,children:isSaving?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Activity,{className:\"w-4 h-4 mr-2 animate-spin\"}),\"Saving...\"]}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(LogIn,{className:\"w-4 h-4 mr-2\"}),\"Check In\"]})})]})]})]})]})})]})})]}),/*#__PURE__*/_jsxs(Tabs,{defaultValue:\"trips\",className:\"w-full\",children:[/*#__PURE__*/_jsxs(TabsList,{className:\"grid w-full grid-cols-2 h-auto\",children:[/*#__PURE__*/_jsxs(TabsTrigger,{value:\"trips\",className:\"flex items-center space-x-1 sm:space-x-2 py-2 sm:py-3\",children:[/*#__PURE__*/_jsx(MapPin,{className:\"w-3 h-3 sm:w-4 sm:h-4\"}),/*#__PURE__*/_jsx(\"span\",{className:\"text-xs sm:text-sm\",children:\"My Trips\"})]}),/*#__PURE__*/_jsxs(TabsTrigger,{value:\"shifts\",className:\"flex items-center space-x-1 sm:space-x-2 py-2 sm:py-3\",children:[/*#__PURE__*/_jsx(Calendar,{className:\"w-3 h-3 sm:w-4 sm:h-4\"}),/*#__PURE__*/_jsx(\"span\",{className:\"text-xs sm:text-sm\",children:\"My Shifts\"})]})]}),/*#__PURE__*/_jsx(TabsContent,{value:\"trips\",className:\"mt-6\",children:/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(CardHeader,{className:\"pb-3 sm:pb-6\",children:[/*#__PURE__*/_jsxs(CardTitle,{className:\"flex items-center space-x-2 text-base sm:text-lg\",children:[/*#__PURE__*/_jsx(MapPin,{className:\"w-4 h-4 sm:w-5 sm:h-5\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Assigned Trips\"})]}),/*#__PURE__*/_jsx(CardDescription,{className:\"text-sm\",children:\"Trips you are assigned to manage\"})]}),/*#__PURE__*/_jsx(CardContent,{children:assignedTrips.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"text-center py-8\",children:[/*#__PURE__*/_jsx(Users,{className:\"w-12 h-12 mx-auto text-gray-400 mb-4\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500\",children:\"No trips assigned.\"})]}):/*#__PURE__*/_jsx(\"div\",{className:\"space-y-4\",children:assignedTrips.map(trip=>/*#__PURE__*/_jsxs(\"div\",{className:\"mb-4\",children:[/*#__PURE__*/_jsx(Card,{className:\"border-l-4 border-l-blue-400\",children:/*#__PURE__*/_jsxs(CardContent,{className:\"p-3 sm:p-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0 mb-3\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center space-x-2 min-w-0 flex-1\",children:/*#__PURE__*/_jsx(\"h4\",{className:\"font-medium text-sm sm:text-base truncate\",children:trip.trip_name})}),/*#__PURE__*/_jsx(Badge,{className:\"text-xs w-fit \".concat(trip.status==='active'?'bg-green-100 text-green-800':trip.status==='in-progress'?'bg-blue-100 text-blue-800':'bg-gray-100 text-gray-800'),children:trip.status})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 text-sm\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{className:\"text-xs text-gray-500\",children:\"Destination\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm\",children:trip.destination})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{className:\"text-xs text-gray-500\",children:\"Dates\"}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-sm\",children:[new Date(trip.start_date).toLocaleDateString(),\" - \",new Date(trip.end_date).toLocaleDateString()]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-3 flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex flex-wrap gap-2\",children:/*#__PURE__*/_jsxs(Badge,{variant:\"outline\",className:\"text-xs\",children:[trip.activecustomerscount||0,\" Active Customers\"]})}),/*#__PURE__*/_jsx(\"div\",{className:\"flex flex-col sm:flex-row gap-2 sm:space-x-2\",children:/*#__PURE__*/_jsx(Button,{size:\"sm\",variant:\"outline\",onClick:()=>{// Toggle expanded state for this trip\nsetExpandedTripId(expandedTripId===trip.id?null:trip.id);// Load customer data if expanding and not already loaded\nif(expandedTripId!==trip.id){loadTripDetails(trip);}},className:\"text-xs w-full sm:w-auto\",children:expandedTripId===trip.id?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(ChevronUp,{className:\"w-3 h-3 mr-1\"}),/*#__PURE__*/_jsx(\"span\",{className:\"hidden sm:inline\",children:\"Hide Customers\"}),/*#__PURE__*/_jsx(\"span\",{className:\"sm:hidden\",children:\"Hide\"})]}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(ChevronDown,{className:\"w-3 h-3 mr-1\"}),/*#__PURE__*/_jsx(\"span\",{className:\"hidden sm:inline\",children:\"View Customers\"}),/*#__PURE__*/_jsx(\"span\",{className:\"sm:hidden\",children:\"View\"})]})})})]})]})}),expandedTripId===trip.id&&/*#__PURE__*/_jsx(\"div\",{className:\"mt-3 pl-2 sm:pl-4 border-l-2 border-blue-200\",children:tripCustomers.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"text-center py-6 bg-gray-50 rounded\",children:[/*#__PURE__*/_jsx(Users,{className:\"w-6 h-6 sm:w-8 sm:h-8 mx-auto text-gray-400 mb-2\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs sm:text-sm text-gray-500\",children:\"Loading customers...\"})]}):/*#__PURE__*/_jsx(\"div\",{className:\"space-y-2 sm:space-y-3\",children:tripCustomers.map(customer=>{var _customer$customer,_customer$customer2;// 使用正确的customer ID和name\nconst customerId=((_customer$customer=customer.customer)===null||_customer$customer===void 0?void 0:_customer$customer.id)||customer.customer_id;const customerName=((_customer$customer2=customer.customer)===null||_customer$customer2===void 0?void 0:_customer$customer2.name)||customer.name;// 筛选当前客户的照片\nconst customerSpecificPhotos=customerPhotos.filter(photo=>photo.customer_id===customerId);// Debug: Photo matching (can be removed in production)\n// console.log(`🔍 Customer ${customerName} (${customerId}):`, {\n//   totalPhotos: customerPhotos.length,\n//   matchingPhotos: customerSpecificPhotos.length\n// });\n// 获取该客户最新的交易和滚码照片\nconst transactionPhotos=customerSpecificPhotos.filter(p=>p.photo_type==='transaction');const rollingPhotos=customerSpecificPhotos.filter(p=>p.photo_type==='rolling');// Photo data available for future features (currently unused)\n// const latestTransactionPhoto = transactionPhotos.length > 0 ? \n//   [...transactionPhotos].sort((a, b) => {\n//     const dateA = new Date(a.upload_date);\n//     const dateB = new Date(b.upload_date);\n//     return dateB.getTime() - dateA.getTime();\n//   })[0] : null;\n// const latestRollingPhoto = rollingPhotos.length > 0 ? \n//   [...rollingPhotos].sort((a, b) => {\n//     const dateA = new Date(a.upload_date);\n//     const dateB = new Date(b.upload_date);\n//     return dateB.getTime() - dateA.getTime();\n//   })[0] : null;\n// Legacy data compatibility (currently unused)\n// const transactions = getCustomerTransactions(customerId);\n// const rolling = getCustomerRolling(customerId);\n// Fallback data for future use (currently unused but kept for potential features)\n// const fallbackTransaction = transactions.length > 0 ? \n//   [...transactions].sort((a, b) => {\n//     const dateA = new Date(a.created_at || a.timestamp);\n//     const dateB = new Date(b.created_at || b.timestamp);\n//     return dateB.getTime() - dateA.getTime();\n//   })[0] : null;\n// const fallbackRolling = rolling.length > 0 ? \n//   [...rolling].sort((a, b) => {\n//     const dateA = new Date(a.created_at || a.timestamp);\n//     const dateB = new Date(b.created_at || b.timestamp);\n//     return dateB.getTime() - dateA.getTime();\n//   })[0] : null;\n// Helper function for photo validation (available for future use)\n// const isValidPhotoData = (photoData: string) => {\n//   if (!photoData) return false;\n//   // Check if it's a valid base64 image data URL and not just \"test\"\n//   return photoData.startsWith('data:image/') && \n//          !photoData.includes('base64,test') && \n//          photoData.length > 100; // Reasonable minimum length for actual image data\n// };\n// Get valid photo data or null (currently unused but available for future features)\n// const validTransactionPhotoData = latestTransactionPhoto?.photo?.data && \n//   isValidPhotoData(latestTransactionPhoto.photo.data) ? \n//   latestTransactionPhoto.photo.data : null;\n// const validRollingPhotoData = latestRollingPhoto?.photo?.data && \n//   isValidPhotoData(latestRollingPhoto.photo.data) ? \n//   latestRollingPhoto.photo.data : null;\n// Debug: Photo display validation (can be removed in production)\n// console.log(`📷 ${customerName} photos:`, {\n//   validTransactionPhotoData: validTransactionPhotoData ? 'Valid' : 'Invalid/Missing',\n//   validRollingPhotoData: validRollingPhotoData ? 'Valid' : 'Invalid/Missing'\n// });\nreturn/*#__PURE__*/_jsx(Card,{className:\"border-l-4 border-l-gray-300\",children:/*#__PURE__*/_jsxs(CardContent,{className:\"p-2 sm:p-3\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-2 sm:space-y-0 mb-3\",children:[/*#__PURE__*/_jsx(\"h5\",{className:\"text-sm sm:text-base font-medium truncate\",children:customerName||\"Customer\"}),/*#__PURE__*/_jsx(Badge,{variant:\"outline\",className:\"bg-green-50 text-green-700 border-green-200 text-xs w-fit\",children:\"Active\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"border rounded p-2 sm:p-3\",children:[/*#__PURE__*/_jsx(\"h6\",{className:\"text-xs sm:text-sm font-medium mb-2\",children:\"Transaction\"}),/*#__PURE__*/_jsx(\"div\",{className:\"mb-3\",children:/*#__PURE__*/_jsx(PhotoDisplay,{photos:transactionPhotos,type:\"transaction\",size:\"medium\",maxPhotos:4,onPhotoDelete:handlePhotoDelete,showDelete:user.role==='admin'||transactionPhotos.some(photo=>photo.uploaded_by===user.staff_id),showDownload:true,userRole:user.role,customerName:customerName})}),/*#__PURE__*/_jsxs(DSButton,{variant:\"outline\",size:\"mobile\",onClick:()=>{setSelectedCustomer(customer);setUploadType('transaction');setIsUploadDialogOpen(true);},icon:/*#__PURE__*/_jsx(Camera,{className:iconSizes.sm}),children:[/*#__PURE__*/_jsx(\"span\",{className:\"hidden sm:inline\",children:\"Upload Transaction Photo\"}),/*#__PURE__*/_jsx(\"span\",{className:\"sm:hidden\",children:\"Upload Transaction\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"border rounded p-2 sm:p-3\",children:[/*#__PURE__*/_jsx(\"h6\",{className:\"text-xs sm:text-sm font-medium mb-2\",children:\"Rolling\"}),/*#__PURE__*/_jsx(\"div\",{className:\"mb-3\",children:/*#__PURE__*/_jsx(PhotoDisplay,{photos:rollingPhotos,type:\"rolling\",size:\"medium\",maxPhotos:4,onPhotoDelete:handlePhotoDelete,showDelete:user.role==='admin'||rollingPhotos.some(photo=>photo.uploaded_by===user.staff_id),showDownload:true,userRole:user.role,customerName:customerName})}),/*#__PURE__*/_jsxs(DSButton,{variant:\"outline\",size:\"mobile\",onClick:()=>{setSelectedCustomer(customer);setUploadType('rolling');setIsUploadDialogOpen(true);},icon:/*#__PURE__*/_jsx(Camera,{className:iconSizes.sm}),children:[/*#__PURE__*/_jsx(\"span\",{className:\"hidden sm:inline\",children:\"Upload Rolling Photo\"}),/*#__PURE__*/_jsx(\"span\",{className:\"sm:hidden\",children:\"Upload Rolling\"})]})]})]})]})},customerId);})})})]},trip.id))})})]})}),/*#__PURE__*/_jsx(TabsContent,{value:\"shifts\",className:\"mt-4 sm:mt-6\",children:/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(CardHeader,{className:\"pb-3 sm:pb-6\",children:[/*#__PURE__*/_jsxs(CardTitle,{className:\"flex items-center space-x-2 text-base sm:text-lg\",children:[/*#__PURE__*/_jsx(Calendar,{className:\"w-4 h-4 sm:w-5 sm:h-5\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Shift History\"})]}),/*#__PURE__*/_jsx(CardDescription,{className:\"text-sm\",children:\"Your recent shifts and attendance\"})]}),/*#__PURE__*/_jsx(CardContent,{children:shifts.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"text-center py-8\",children:[/*#__PURE__*/_jsx(Clock,{className:\"w-12 h-12 mx-auto text-gray-400 mb-4\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500\",children:\"No shift history found.\"})]}):/*#__PURE__*/_jsx(\"div\",{className:\"space-y-4\",children:shifts.sort((a,b)=>{// Sort by newest date/time first\nconst dateA=new Date(a.check_in_time||a.shift_date||a.checkInTime||a.shiftDate);const dateB=new Date(b.check_in_time||b.shift_date||b.checkInTime||b.shiftDate);return dateB.getTime()-dateA.getTime();}).slice(0,10).map(shift=>/*#__PURE__*/_jsx(Card,{className:\"border-l-4 border-l-blue-400\",children:/*#__PURE__*/_jsxs(CardContent,{className:\"p-3 sm:p-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0 mb-3\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(Calendar,{className:\"w-3 h-3 sm:w-4 sm:h-4 text-gray-400\"}),/*#__PURE__*/_jsx(\"span\",{className:\"font-medium text-sm sm:text-base\",children:shift.shift_date})]}),/*#__PURE__*/_jsx(Badge,{className:\"text-xs w-fit \".concat(shift.status==='checked-in'?'bg-green-100 text-green-800':'bg-gray-100 text-gray-800'),children:shift.status==='checked-in'?'On Duty':'Completed'})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 text-sm\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{className:\"text-xs text-gray-500\",children:\"Check-in Time\"}),/*#__PURE__*/_jsx(\"p\",{children:new Date(shift.check_in_time).toLocaleString()}),shift.check_in_photo&&/*#__PURE__*/_jsx(\"div\",{className:\"mt-2\",children:/*#__PURE__*/_jsx(ImageWithFallback,{src:shift.check_in_photo,alt:\"Check-in proof\",className:\"w-12 h-12 sm:w-16 sm:h-16 object-cover rounded border\"})})]}),shift.check_out_time&&/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{className:\"text-xs text-gray-500\",children:\"Check-out Time\"}),/*#__PURE__*/_jsx(\"p\",{children:new Date(shift.check_out_time).toLocaleString()}),shift.check_out_photo&&/*#__PURE__*/_jsx(\"div\",{className:\"mt-2\",children:/*#__PURE__*/_jsx(ImageWithFallback,{src:shift.check_out_photo,alt:\"Check-out proof\",className:\"w-12 h-12 sm:w-16 sm:h-16 object-cover rounded border\"})})]})]}),shift.notes&&/*#__PURE__*/_jsxs(\"div\",{className:\"mt-3 p-2 bg-gray-50 rounded text-xs\",children:[/*#__PURE__*/_jsx(Label,{className:\"text-gray-500\",children:\"Notes\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-700 mt-1\",children:shift.notes})]})]})},shift.id))})})]})})]}),/*#__PURE__*/_jsx(Dialog,{open:isUploadDialogOpen,onOpenChange:setIsUploadDialogOpen,children:/*#__PURE__*/_jsxs(DialogContent,{className:\"max-w-md\",children:[/*#__PURE__*/_jsxs(DialogHeader,{children:[/*#__PURE__*/_jsxs(DialogTitle,{className:\"flex items-center space-x-2\",children:[uploadType==='transaction'?/*#__PURE__*/_jsx(DollarSign,{className:\"w-5 h-5\"}):/*#__PURE__*/_jsx(Camera,{className:\"w-5 h-5\"}),/*#__PURE__*/_jsxs(\"span\",{children:[\"Upload \",uploadType==='transaction'?'Transaction':'Rolling',\" Photo\"]})]}),/*#__PURE__*/_jsxs(DialogDescription,{children:[\"Upload proof photo for \",selectedTripForUpload===null||selectedTripForUpload===void 0?void 0:selectedTripForUpload.trip_name]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-4\",children:[selectedCustomer&&/*#__PURE__*/_jsxs(\"div\",{className:\"p-3 bg-blue-50 rounded border\",children:[/*#__PURE__*/_jsx(Label,{className:\"text-sm font-medium text-blue-800\",children:\"Selected Customer\"}),/*#__PURE__*/_jsx(\"div\",{className:\"mt-1\",children:/*#__PURE__*/_jsx(\"p\",{className:\"font-medium\",children:selectedCustomer.customer_name||selectedCustomer.name})})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{htmlFor:\"uploadDate\",children:\"Date (Required)\"}),/*#__PURE__*/_jsx(Input,{id:\"uploadDate\",type:\"date\",value:uploadDate,onChange:e=>setUploadDate(e.target.value),disabled:isSaving,required:true,className:\"mb-2\"})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{htmlFor:\"uploadPhoto\",children:\"Upload Photo\"}),/*#__PURE__*/_jsx(Input,{id:\"uploadPhoto\",type:\"file\",accept:\"image/*\",onChange:e=>{if(e.target.files&&e.target.files[0]){setUploadPhoto(e.target.files[0]);}},disabled:isSaving,required:true})]}),uploadPhoto&&/*#__PURE__*/_jsxs(\"div\",{className:\"mt-2\",children:[/*#__PURE__*/_jsx(Label,{className:\"text-sm mb-1 block\",children:\"Photo Preview\"}),/*#__PURE__*/_jsx(\"div\",{className:\"border rounded p-2 bg-gray-50\",children:/*#__PURE__*/_jsx(\"img\",{src:URL.createObjectURL(uploadPhoto),alt:\"Preview\",className:\"max-h-40 mx-auto object-contain\"})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-end space-x-2\",children:[/*#__PURE__*/_jsx(Button,{type:\"button\",variant:\"outline\",onClick:()=>setIsUploadDialogOpen(false),disabled:isSaving,children:\"Cancel\"}),/*#__PURE__*/_jsx(Button,{onClick:handlePhotoUpload,disabled:!uploadPhoto||!uploadDate||isSaving,children:isSaving?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Loader2,{className:\"mr-2 h-4 w-4 animate-spin\"}),\"Uploading...\"]}):'Upload'})]})]})]})})]});}export const StaffSelfService=withErrorHandler(StaffSelfServiceComponent);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}