{"ast":null,"code":"import _objectSpread from\"/Users/user/Desktop/Cursor New Management System/management-system-1/Junket Management System Source Code/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect,useCallback}from'react';import{Button}from'./ui/button';import{Input}from'./ui/input';import{Label}from'./ui/label';import{Card,CardContent,CardDescription,CardHeader,CardTitle}from'./ui/card';import{Dialog,DialogContent,DialogDescription,DialogHeader,DialogTitle,DialogTrigger}from'./ui/dialog';import{AlertDialog,AlertDialogAction,AlertDialogCancel,AlertDialogContent,AlertDialogDescription,AlertDialogFooter,AlertDialogHeader,AlertDialogTitle,AlertDialogTrigger}from'./ui/alert-dialog';import{Badge}from'./ui/badge';import{Tabs,TabsContent,TabsList,TabsTrigger}from'./ui/tabs';import{Collapsible,CollapsibleContent,CollapsibleTrigger}from'./ui/collapsible';import{FileUpload}from'./FileUpload';import{withErrorHandler}from'./withErrorHandler';import{isReadOnlyRole,canViewFinancialData}from'../utils/permissions';import{apiClient}from'../utils/api/apiClient';import{Plus,Edit,Mail,Phone,Paperclip,ChevronDown,ChevronUp,UserCheck,Save,Eye}from'lucide-react';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";function AgentManagementComponent(_ref){let{user,showError,clearError}=_ref;const isReadOnly=isReadOnlyRole(user.role);const canSeeFinancials=canViewFinancialData(user.role);const[agents,setAgents]=useState([]);const[isDialogOpen,setIsDialogOpen]=useState(false);const[editingAgent,setEditingAgent]=useState(null);const[deletingAgent,setDeletingAgent]=useState(null);const[expandedAgent,setExpandedAgent]=useState(null);const[loading,setLoading]=useState(true);const[saving,setSaving]=useState(false);const[formData,setFormData]=useState({name:'',email:'',phone:''});const loadAllData=useCallback(async()=>{try{setLoading(true);clearError();console.log('ðŸ”„ Loading agent data from backend API...');// Load agents from backend API\nconst agentsResponse=await apiClient.getAgents();if(!agentsResponse.success){throw new Error(agentsResponse.error||'Failed to fetch agents');}// Process agents - all agents are automatically customers\nconst agentsData=Array.isArray(agentsResponse.data)?agentsResponse.data:[];const processedAgents=agentsData.map(agent=>_objectSpread(_objectSpread({},agent),{},{isCustomer:true,// All agents are customers by default\nattachments:agent.attachments||[],createdAt:new Date(agent.created_at).toLocaleDateString()}));setAgents(processedAgents);console.log(\"\\u2705 Loaded \".concat(processedAgents.length,\" agents from backend API\"));}catch(error){console.error('âŒ Error loading agent data:',error);showError(\"Failed to load agent data: \".concat(error instanceof Error?error.message:'Unknown error occurred'));}finally{setLoading(false);}},[clearError,showError]);useEffect(()=>{loadAllData();},[loadAllData]);// Note: Direct agent saving removed - now using backend API endpoints\n// Note: Customer saving handled automatically when agents are created/updated\nconst handleSubmit=async e=>{e.preventDefault();try{setSaving(true);if(editingAgent){// Update existing agent - only send required fields to backend\nconst updateData={name:formData.name,email:formData.email,phone:formData.phone||null,status:'active'};const response=await apiClient.updateAgent(editingAgent.id,updateData);if(!response.success){throw new Error(response.error||'Failed to update agent');}// Refresh data to get updated agent\nawait loadAllData();}else{// Add new agent - only send required fields to backend\nconst agentData={name:formData.name,email:formData.email,phone:formData.phone||null,commission_rate:0,status:'active'};// Create agent via API (backend automatically creates corresponding customer with agent_id)\nconst agentResponse=await apiClient.createAgent(agentData);if(!agentResponse.success){throw new Error(agentResponse.error||'Failed to create agent');}// Refresh data to get the new agent and customer\nawait loadAllData();}// Reset form and close dialog\nsetFormData({name:'',email:'',phone:''});setEditingAgent(null);setIsDialogOpen(false);}catch(error){showError(\"Failed to save agent: \".concat(error instanceof Error?error.message:'Unknown error occurred'));}finally{setSaving(false);}};const handleEdit=agent=>{setEditingAgent(agent);setFormData({name:agent.name,email:agent.email,phone:agent.phone});setIsDialogOpen(true);};// Note: Agent-to-customer creation is now handled automatically by the backend\n// when an agent is created, so no manual customer creation is needed\nconst handleDeleteAgent=async()=>{if(!deletingAgent)return;try{setSaving(true);clearError();console.log('ðŸ—‘ï¸ Deleting agent:',deletingAgent.name,deletingAgent.id);// Call backend API to delete agent\nconst response=await apiClient.deleteAgent(deletingAgent.id);if(!response.success){throw new Error(response.error||'Failed to delete agent');}console.log('âœ… Agent deleted successfully');// Refresh data to get updated agent list\nawait loadAllData();// Close dialog and reset state\nsetDeletingAgent(null);}catch(error){console.error('âŒ Error deleting agent:',error);showError(\"Failed to delete agent: \".concat(error instanceof Error?error.message:'Unknown error occurred'));}finally{setSaving(false);}};const openNewAgentDialog=()=>{setEditingAgent(null);setFormData({name:'',email:'',phone:''});setIsDialogOpen(true);};const toggleAgentExpansion=agentId=>{setExpandedAgent(expandedAgent===agentId?null:agentId);};const updateAgentAttachments=async(agentId,attachments)=>{// Note: Attachment management would need to be implemented via API\nconsole.log('Attachment update requested for agent:',agentId,attachments);};const isAdmin=user.role==='admin';const isStaff=user.role==='staff';// Show loading state\nif(loading){return/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center justify-center h-64\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-600\",children:\"Loading agent data from Supabase...\"})]})});}return/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-6\",children:[isStaff&&/*#__PURE__*/_jsx(\"div\",{className:\"p-4 bg-blue-50 border border-blue-200 rounded-lg\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center\",children:[/*#__PURE__*/_jsx(Eye,{className:\"w-5 h-5 text-blue-600 mr-2\"}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-sm font-medium text-blue-800\",children:\"Agent Information - View Only\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-blue-600\",children:\"You have read-only access to agent information and contact details.\"})]})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between items-center\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h2\",{className:\"text-2xl font-bold\",children:\"Agent Management\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-600\",children:isStaff?'View agent information and contact details.':'Manage agents who bring customers to the casino. All agents are automatically customers.'})]}),!isReadOnly&&/*#__PURE__*/_jsxs(Dialog,{open:isDialogOpen,onOpenChange:setIsDialogOpen,children:[/*#__PURE__*/_jsx(DialogTrigger,{asChild:true,children:/*#__PURE__*/_jsxs(Button,{onClick:openNewAgentDialog,disabled:saving,children:[/*#__PURE__*/_jsx(Plus,{className:\"w-4 h-4 mr-2\"}),\"Add Agent\"]})}),/*#__PURE__*/_jsxs(DialogContent,{children:[/*#__PURE__*/_jsxs(DialogHeader,{children:[/*#__PURE__*/_jsx(DialogTitle,{children:editingAgent?'Edit Agent':'Add New Agent'}),/*#__PURE__*/_jsx(DialogDescription,{children:editingAgent?'Update agent information':'Add a new agent to the system'})]}),/*#__PURE__*/_jsxs(\"form\",{onSubmit:handleSubmit,className:\"space-y-4\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{htmlFor:\"name\",children:\"Name\"}),/*#__PURE__*/_jsx(Input,{id:\"name\",value:formData.name,onChange:e=>setFormData(_objectSpread(_objectSpread({},formData),{},{name:e.target.value})),placeholder:\"Agent full name\",required:true,disabled:saving})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{htmlFor:\"email\",children:\"Email\"}),/*#__PURE__*/_jsx(Input,{id:\"email\",type:\"email\",value:formData.email,onChange:e=>setFormData(_objectSpread(_objectSpread({},formData),{},{email:e.target.value})),placeholder:\"agent@email.com\",required:true,disabled:saving})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{htmlFor:\"phone\",children:\"Phone\"}),/*#__PURE__*/_jsx(Input,{id:\"phone\",value:formData.phone,onChange:e=>setFormData(_objectSpread(_objectSpread({},formData),{},{phone:e.target.value})),placeholder:\"+1234567890\",required:true,disabled:saving})]}),/*#__PURE__*/_jsx(\"div\",{className:\"p-3 bg-green-50 border border-green-200 rounded-lg\",children:/*#__PURE__*/_jsxs(\"p\",{className:\"text-xs text-green-700\",children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Note:\"}),\" All agents are automatically registered as customers and can participate in trips and gambling activities.\"]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"p-4 bg-blue-50 border border-blue-200 rounded-lg\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center space-x-2 mb-2\",children:/*#__PURE__*/_jsx(\"span\",{className:\"text-sm font-medium text-blue-800\",children:\"Profit Sharing\"})}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-blue-700\",children:\"Agent profit sharing percentages are configured per trip in the Projects section.\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-end space-x-2\",children:[/*#__PURE__*/_jsx(Button,{type:\"button\",variant:\"outline\",onClick:()=>setIsDialogOpen(false),disabled:saving,children:\"Cancel\"}),/*#__PURE__*/_jsx(Button,{type:\"submit\",disabled:saving,children:saving?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Save,{className:\"w-4 h-4 mr-2 animate-spin\"}),\"Saving to Supabase...\"]}):/*#__PURE__*/_jsxs(_Fragment,{children:[editingAgent?'Update':'Add',\" Agent\"]})})]})]})]})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"grid gap-6\",children:agents.length===0?/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsx(CardContent,{className:\"text-center py-12\",children:/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500\",children:isStaff?'No agents found in the system.':'No agents found. Add your first agent to get started.'})})}):agents.map(agent=>{var _agent$attachments;const isExpanded=expandedAgent===agent.id;return/*#__PURE__*/_jsx(Collapsible,{open:isExpanded,onOpenChange:()=>toggleAgentExpansion(agent.id),children:/*#__PURE__*/_jsxs(Card,{className:\"overflow-hidden\",children:[/*#__PURE__*/_jsx(CollapsibleTrigger,{asChild:true,children:/*#__PURE__*/_jsx(CardHeader,{className:\"cursor-pointer hover:bg-gray-50 transition-colors\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between items-start\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex-1\",children:[/*#__PURE__*/_jsxs(CardTitle,{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(\"span\",{children:agent.name}),/*#__PURE__*/_jsx(Badge,{variant:agent.status?\"default\":\"default\",children:agent.status?'Active':'Inactive'}),agent.attachments&&agent.attachments.length>0&&/*#__PURE__*/_jsxs(Badge,{variant:\"outline\",className:\"flex items-center space-x-1\",children:[/*#__PURE__*/_jsx(Paperclip,{className:\"w-3 h-3\"}),/*#__PURE__*/_jsx(\"span\",{children:agent.attachments.length})]}),isStaff&&/*#__PURE__*/_jsxs(Badge,{variant:\"outline\",className:\"bg-yellow-50 text-yellow-700 border-yellow-200\",children:[/*#__PURE__*/_jsx(Eye,{className:\"w-3 h-3 mr-1\"}),\"View Only\"]})]}),/*#__PURE__*/_jsxs(CardDescription,{children:[\"Agent since \",agent.createdAt]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center space-x-2\",children:isExpanded?/*#__PURE__*/_jsx(ChevronUp,{className:\"w-5 h-5 text-gray-400\"}):/*#__PURE__*/_jsx(ChevronDown,{className:\"w-5 h-5 text-gray-400\"})})]})})}),/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(Mail,{className:\"w-4 h-4 text-gray-400\"}),/*#__PURE__*/_jsx(\"span\",{className:\"text-sm\",children:agent.email})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(Phone,{className:\"w-4 h-4 text-gray-400\"}),/*#__PURE__*/_jsx(\"span\",{className:\"text-sm\",children:agent.phone})]})]}),!isReadOnly&&/*#__PURE__*/_jsxs(\"div\",{className:\"flex space-x-2\",children:[/*#__PURE__*/_jsxs(Button,{variant:\"outline\",size:\"sm\",onClick:()=>handleEdit(agent),disabled:saving,children:[/*#__PURE__*/_jsx(Edit,{className:\"w-4 h-4 mr-2\"}),\"Edit\"]}),/*#__PURE__*/_jsxs(AlertDialog,{open:(deletingAgent===null||deletingAgent===void 0?void 0:deletingAgent.id)===agent.id,onOpenChange:open=>!open&&setDeletingAgent(null),children:[/*#__PURE__*/_jsx(AlertDialogTrigger,{asChild:true,children:/*#__PURE__*/_jsx(Button,{variant:\"destructive\",size:\"sm\",onClick:()=>setDeletingAgent(agent),disabled:saving,className:\"bg-red-600 hover:bg-red-700 text-white\",children:\"Delete\"})}),/*#__PURE__*/_jsxs(AlertDialogContent,{children:[/*#__PURE__*/_jsxs(AlertDialogHeader,{children:[/*#__PURE__*/_jsx(AlertDialogTitle,{children:\"Delete Agent\"}),/*#__PURE__*/_jsxs(AlertDialogDescription,{children:[\"Are you sure you want to permanently delete \\\"\",agent.name,\"\\\"? This action cannot be undone and will remove all agent data from the system.\",/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(\"strong\",{children:\"Warning:\"}),\" This will also affect any trips this agent is associated with. Agents with existing trip associations cannot be deleted.\"]})]}),/*#__PURE__*/_jsxs(AlertDialogFooter,{children:[/*#__PURE__*/_jsx(AlertDialogCancel,{disabled:saving,children:\"Cancel\"}),/*#__PURE__*/_jsx(AlertDialogAction,{onClick:handleDeleteAgent,className:\"bg-red-600 text-white hover:bg-red-700\",disabled:saving,children:saving?'Deleting...':'Delete Agent'})]})]})]})]}),/*#__PURE__*/_jsx(CollapsibleContent,{className:\"mt-6\",children:/*#__PURE__*/_jsxs(Tabs,{defaultValue:\"info\",className:\"w-full\",children:[/*#__PURE__*/_jsxs(TabsList,{className:\"grid w-full grid-cols-2\",children:[/*#__PURE__*/_jsxs(TabsTrigger,{value:\"info\",className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(UserCheck,{className:\"w-4 h-4\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Agent Information\"})]}),/*#__PURE__*/_jsxs(TabsTrigger,{value:\"files\",className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(Paperclip,{className:\"w-4 h-4\"}),/*#__PURE__*/_jsxs(\"span\",{children:[\"Files (\",((_agent$attachments=agent.attachments)===null||_agent$attachments===void 0?void 0:_agent$attachments.length)||0,\")\"]})]})]}),/*#__PURE__*/_jsxs(TabsContent,{value:\"info\",className:\"space-y-4 mt-6\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-1 md:grid-cols-2 gap-6\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-4\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{className:\"text-sm font-medium text-gray-500\",children:\"Name\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-lg\",children:agent.name})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{className:\"text-sm font-medium text-gray-500\",children:\"Email\"}),/*#__PURE__*/_jsx(\"p\",{children:agent.email})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{className:\"text-sm font-medium text-gray-500\",children:\"Phone\"}),/*#__PURE__*/_jsx(\"p\",{children:agent.phone})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-4\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{className:\"text-sm font-medium text-gray-500\",children:\"Status\"}),/*#__PURE__*/_jsx(Badge,{variant:agent.status?\"default\":\"default\",children:agent.status?'Active':'Inactive'})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{className:\"text-sm font-medium text-gray-500\",children:\"Member Since\"}),/*#__PURE__*/_jsx(\"p\",{children:agent.createdAt})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{className:\"text-sm font-medium text-gray-500\",children:\"Role\"}),/*#__PURE__*/_jsxs(Badge,{variant:\"outline\",className:\"bg-blue-50 text-blue-700 border-blue-200\",children:[/*#__PURE__*/_jsx(UserCheck,{className:\"w-3 h-3 mr-1\"}),\"Agent\"]})]})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"pt-4 border-t\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"p-4 bg-blue-50 border border-blue-200 rounded-lg\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center space-x-2 mb-2\",children:/*#__PURE__*/_jsx(\"span\",{className:\"text-sm font-medium text-blue-800\",children:\"Profit Sharing Information\"})}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-blue-700\",children:\"This agent's profit sharing percentages are configured individually for each trip in the Projects section. As both an agent and customer, they can participate in trips and receive commissions based on their role in each trip.\"})]})})]}),/*#__PURE__*/_jsxs(TabsContent,{value:\"files\",className:\"space-y-4 mt-6\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"mb-4\",children:[/*#__PURE__*/_jsx(Label,{className:\"text-sm font-medium text-gray-500\",children:\"Document Management\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-400\",children:isAdmin?'Upload passport, photo, and other important documents for this agent.':'View uploaded documents for this agent.'})]}),isAdmin?/*#__PURE__*/_jsx(FileUpload,{attachments:agent.attachments||[],onAttachmentsChange:attachments=>updateAgentAttachments(agent.id,attachments),currentUser:user.username,disabled:saving}):/*#__PURE__*/_jsx(\"div\",{className:\"space-y-2\",children:agent.attachments&&agent.attachments.length>0?agent.attachments.map(file=>/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center justify-between p-3 border rounded-lg\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-3\",children:[/*#__PURE__*/_jsx(Paperclip,{className:\"w-4 h-4 text-gray-400\"}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-sm font-medium\",children:file.name}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-xs text-gray-500\",children:[(file.size/1024/1024).toFixed(2),\" MB \\u2022 Uploaded by \",file.uploadedBy,\" on \",new Date(file.uploadedAt).toLocaleDateString()]})]})]})},file.id)):/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-500 text-center py-8\",children:\"No documents uploaded for this agent.\"})})]})]})})]})]})},agent.id);})})]});}// Export with error handler wrapper\nexport const AgentManagement=withErrorHandler(AgentManagementComponent);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}