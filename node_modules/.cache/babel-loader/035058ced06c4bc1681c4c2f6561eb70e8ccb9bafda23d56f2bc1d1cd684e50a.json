{"ast":null,"code":"import _objectSpread from\"/Users/user/Desktop/Cursor New Management System/management-system-1/Junket Management System Source Code/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect,useCallback}from'react';import{Card,CardContent,CardHeader,CardTitle,CardDescription}from'./ui/card';import{Alert,AlertDescription}from'./ui/alert';import{Badge}from'./ui/badge';import{Button}from'./ui/button';import{Users,UserCheck,TrendingDown,DollarSign,Receipt,Trophy,Target,MapPin,Activity,Database,RefreshCw,AlertTriangle,Zap}from'lucide-react';import{db}from'../utils/supabase/supabaseClients';import{apiClient}from'../utils/api/apiClient';// Type definitions\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";// Real-time refresh interval (30 seconds)\nconst REAL_TIME_REFRESH_INTERVAL=30000;export function Dashboard(_ref){let{user}=_ref;// Data states with real-time updates\nconst[agents,setAgents]=useState([]);const[customers,setCustomers]=useState([]);const[trips,setTrips]=useState([]);const[rollingRecords,setRollingRecords]=useState([]);const[buyInOutRecords,setBuyInOutRecords]=useState([]);// Loading and sync states\nconst[loading,setLoading]=useState(true);const[refreshing,setRefreshing]=useState(false);const[lastSyncTime,setLastSyncTime]=useState(null);const[connectionStatus,setConnectionStatus]=useState('connected');const[errorMessage,setErrorMessage]=useState('');const[isRealTimeEnabled,setIsRealTimeEnabled]=useState(true);// Helper functions\nconst safeFormatNumber=value=>{if(value===undefined||value===null||isNaN(value)){return'0';}return value.toLocaleString();};const safeNumber=value=>{if(value===undefined||value===null||isNaN(value)){return 0;}return value;};// Real-time data loading from Supabase with API integration\nconst loadRealTimeData=useCallback(async()=>{try{setRefreshing(true);setErrorMessage('');console.log('🔄 Loading real-time dashboard data from API...');// Load all required data from API in parallel\nconst[agentsData,customersData,transactionsData,tripsApiResponse]=await Promise.all([db.get('agents',[]),db.get('customers',[]),db.get('transactions',[]),apiClient.getTripsWithSharing()]);const tripsData=tripsApiResponse.data||[];console.log('📊 Dashboard data loaded:',{agents:Array.isArray(agentsData)?agentsData.length:0,customers:Array.isArray(customersData)?customersData.length:0,trips:Array.isArray(tripsData)?tripsData.length:0,transactions:Array.isArray(transactionsData)?transactionsData.length:0});// Debug: Log sample data\nif(Array.isArray(customersData)&&customersData.length>0){console.log('🔍 Sample customer data:',customersData[0]);}if(Array.isArray(tripsData)&&tripsData.length>0){console.log('🔍 Sample trip data with sharing:',tripsData[0]);}if(Array.isArray(transactionsData)&&transactionsData.length>0){console.log('🔍 Sample transaction data:',transactionsData[0]);}// Process customers - use database totals directly\nconst processedCustomers=(Array.isArray(customersData)?customersData:[]).map(customer=>{return _objectSpread(_objectSpread({},customer),{},{id:customer.id,name:customer.name,agentName:customer.agent_name,isActive:customer.status==='active',totalRolling:parseFloat(customer.total_rolling)||0,totalWinLoss:parseFloat(customer.total_win_loss)||0,totalBuyIn:parseFloat(customer.total_buy_in)||0,totalBuyOut:parseFloat(customer.total_buy_out)||0,attachments:customer.attachments||[],isAgent:customer.is_agent||false,rollingPercentage:parseFloat(customer.rolling_percentage)||1.4,creditLimit:parseFloat(customer.credit_limit)||0,availableCredit:parseFloat(customer.available_credit)||0});});// Process trips - preserve sharing data from API directly\nconst processedTrips=(Array.isArray(tripsData)?tripsData:[]).map(trip=>{console.log('🔍 Processing trip:',trip.trip_name,'sharing data:',trip.sharing);return _objectSpread(_objectSpread({},trip),{},{attachments:trip.attachments||[]// Don't override sharing - keep original API data\n});});// Set processed data\nsetAgents(agentsData);setCustomers(processedCustomers);setTrips(processedTrips);setRollingRecords([]);// No longer extracting from trips\nsetBuyInOutRecords(transactionsData||[]);setLastSyncTime(new Date());setConnectionStatus('connected');console.log(\"\\u2705 Real-time dashboard data loaded: \".concat(processedCustomers.length,\" customers, \").concat(agentsData.length,\" agents, \").concat(processedTrips.length,\" trips with sharing data\"));}catch(error){console.error('❌ Error loading real-time dashboard data:',error);const errorMessage=error instanceof Error?error.message:'Unknown error occurred';setErrorMessage(\"Failed to load dashboard data: \".concat(errorMessage));setConnectionStatus('error');}finally{setLoading(false);setRefreshing(false);}},[]);// Real-time data sync with automatic refresh\nuseEffect(()=>{loadRealTimeData();// Set up real-time refresh interval\nlet refreshInterval;if(isRealTimeEnabled){refreshInterval=setInterval(()=>{console.log('🔄 Real-time dashboard refresh triggered');loadRealTimeData();},REAL_TIME_REFRESH_INTERVAL);}return()=>{if(refreshInterval){clearInterval(refreshInterval);}};},[loadRealTimeData,isRealTimeEnabled]);// Toggle real-time updates\nconst toggleRealTime=()=>{setIsRealTimeEnabled(!isRealTimeEnabled);if(!isRealTimeEnabled){loadRealTimeData();// Refresh immediately when re-enabling\n}};// Filter data based on user role\nconst getFilteredData=()=>{let filteredCustomers=customers;let filteredTrips=trips;if(user.role==='agent'&&user.agentId){filteredCustomers=customers.filter(c=>c.agentId===user.agentId);filteredTrips=trips.filter(t=>t.agents&&t.agents.some(agent=>agent.agentId===user.agentId)||t.agentId===user.agentId);}return{filteredCustomers,filteredTrips};};const{filteredCustomers,filteredTrips}=getFilteredData();// Calculate comprehensive metrics from real-time data\nconst calculateMetrics=()=>{// Trip-based financial metrics\nconst tripTotalRolling=filteredTrips.reduce((sum,trip)=>sum+safeNumber(trip.totalRolling),0);const tripTotalWinLoss=filteredTrips.reduce((sum,trip)=>sum+safeNumber(trip.totalWinLoss),0);const totalRollingCommission=filteredTrips.reduce((sum,trip)=>sum+safeNumber(trip.calculatedTotalRolling),0);const totalExpenses=filteredTrips.reduce((sum,trip)=>sum+(trip.expenses||[]).reduce((expSum,exp)=>expSum+safeNumber(exp.amount),0),0);// Customer metrics\nconst totalCustomers=filteredCustomers.length;const activeCustomers=filteredCustomers.filter(c=>c.isActive).length;const customerTotalWinLoss=filteredCustomers.reduce((sum,c)=>sum+safeNumber(c.totalWinLoss),0);const customerTotalBuyIn=filteredCustomers.reduce((sum,c)=>sum+safeNumber(c.totalBuyIn),0);const customerTotalBuyOut=filteredCustomers.reduce((sum,c)=>sum+safeNumber(c.totalBuyOut),0);// Total Rolling from trip_sharing table (always positive for rebate calculation)\nconst tripSharingTotalRolling=trips.reduce((sum,trip)=>{var _trip$sharing,_trip$sharing2,_trip$sharing3;const value=Math.abs(safeNumber(((_trip$sharing=trip.sharing)===null||_trip$sharing===void 0?void 0:_trip$sharing.total_rolling)||((_trip$sharing2=trip.sharing)===null||_trip$sharing2===void 0?void 0:_trip$sharing2.totalRolling)));console.log(\"Trip \".concat(trip.trip_name,\": total_rolling = \").concat((_trip$sharing3=trip.sharing)===null||_trip$sharing3===void 0?void 0:_trip$sharing3.total_rolling,\", contributing \").concat(value,\" to total rolling\"));return sum+value;},0);// Agent metrics\nconst totalAgents=agents.length;const activeAgents=agents.filter(a=>a.status==='active').length;// Trip metrics\nconst totalTrips=filteredTrips.length;const completedTrips=filteredTrips.filter(t=>t.status==='completed').length;const ongoingTrips=filteredTrips.filter(t=>t.status==='ongoing').length;const plannedTrips=filteredTrips.filter(t=>t.status==='planned').length;// Calculate metrics from trip_sharing table data (all trips, no filtering)\nconsole.log('🔍 Debug trips data for calculations:',trips.length);trips.forEach((trip,index)=>{console.log(\"Trip \".concat(index+1,\" (\").concat(trip.trip_name,\"):\"),{hasSharing:!!trip.sharing,sharingKeys:trip.sharing?Object.keys(trip.sharing):'no sharing',sharingData:trip.sharing});});const tripSharingGrossProfit=trips.reduce((sum,trip)=>{var _trip$sharing4,_trip$sharing5,_trip$sharing6;const value=Math.abs(safeNumber(((_trip$sharing4=trip.sharing)===null||_trip$sharing4===void 0?void 0:_trip$sharing4.total_win_loss)||((_trip$sharing5=trip.sharing)===null||_trip$sharing5===void 0?void 0:_trip$sharing5.totalWinLoss)));console.log(\"Trip \".concat(trip.trip_name,\": total_win_loss = \").concat((_trip$sharing6=trip.sharing)===null||_trip$sharing6===void 0?void 0:_trip$sharing6.total_win_loss,\", contributing \").concat(value,\" to gross profit\"));return sum+value;},0);const tripSharingExpenses=trips.reduce((sum,trip)=>{var _trip$sharing7,_trip$sharing8,_trip$sharing9;const value=Math.abs(safeNumber(((_trip$sharing7=trip.sharing)===null||_trip$sharing7===void 0?void 0:_trip$sharing7.total_expenses)||((_trip$sharing8=trip.sharing)===null||_trip$sharing8===void 0?void 0:_trip$sharing8.totalExpenses)));console.log(\"Trip \".concat(trip.trip_name,\": total_expenses = \").concat((_trip$sharing9=trip.sharing)===null||_trip$sharing9===void 0?void 0:_trip$sharing9.total_expenses,\", contributing \").concat(value,\" to expenses\"));return sum+value;},0);const tripSharingNetProfit=trips.reduce((sum,trip)=>{var _trip$sharing0,_trip$sharing1,_trip$sharing10;const value=safeNumber(((_trip$sharing0=trip.sharing)===null||_trip$sharing0===void 0?void 0:_trip$sharing0.company_share)||((_trip$sharing1=trip.sharing)===null||_trip$sharing1===void 0?void 0:_trip$sharing1.companyShare));console.log(\"Trip \".concat(trip.trip_name,\": company_share = \").concat((_trip$sharing10=trip.sharing)===null||_trip$sharing10===void 0?void 0:_trip$sharing10.company_share,\", contributing \").concat(value,\" to net profit\"));return sum+value;},0);console.log('📊 Final calculations:',{tripSharingGrossProfit,tripSharingExpenses,tripSharingNetProfit});// House performance calculations (using trip_sharing data)\nconst houseGrossWin=tripSharingGrossProfit;const houseNetWin=houseGrossWin-totalRollingCommission;const houseFinalProfit=tripSharingNetProfit;// Performance ratios (using trip_sharing total_rolling)\nconst profitMargin=tripSharingTotalRolling>0?houseFinalProfit/tripSharingTotalRolling*100:0;const expenseRatio=tripSharingTotalRolling>0?totalExpenses/tripSharingTotalRolling*100:0;const commissionRatio=tripSharingTotalRolling>0?totalRollingCommission/tripSharingTotalRolling*100:0;// Recent activity metrics\nconst recentRollingRecords=rollingRecords.filter(record=>Date.now()-new Date(record.recordedAt).getTime()<24*60*60*1000).length;const recentBuyInOutRecords=buyInOutRecords.filter(record=>Date.now()-new Date(record.timestamp).getTime()<24*60*60*1000).length;return{// Trip metrics\ntripTotalRolling,tripTotalWinLoss,totalRollingCommission,totalExpenses:tripSharingExpenses,// Customer metrics\ntotalCustomers,activeCustomers,customerTotalRolling:tripSharingTotalRolling,// Use trip_sharing total_rolling\ncustomerTotalWinLoss,customerTotalBuyIn,customerTotalBuyOut,// Agent metrics\ntotalAgents,activeAgents,// Trip counts\ntotalTrips,completedTrips,ongoingTrips,plannedTrips,// House performance\nhouseGrossWin,houseNetWin,houseFinalProfit,// Ratios\nprofitMargin,expenseRatio,commissionRatio,// Activity\nrecentRollingRecords,recentBuyInOutRecords,totalRollingRecords:rollingRecords.length,totalBuyInOutRecords:buyInOutRecords.length};};const metrics=calculateMetrics();// Filter active trips and use trip_sharing data\nconst activeTrips=filteredTrips.filter(trip=>trip.status&&trip.status.toLowerCase()==='active').map(trip=>{// Use trip_sharing data directly instead of enriching with calculations\nconst tripCustomers=filteredCustomers.filter(c=>{var _trip$customers;return(_trip$customers=trip.customers)===null||_trip$customers===void 0?void 0:_trip$customers.some(tc=>tc.customerId===c.id||tc.customer_id===c.id);});return _objectSpread(_objectSpread({},trip),{},{customers:tripCustomers// Keep original sharing data from trip_sharing table\n});});const getWinLossStatus=winLoss=>{if(winLoss===0){return{text:'Break Even',icon:Target,color:'text-gray-600'};}else if(winLoss>0){return{text:'Junket Loss',icon:TrendingDown,color:'text-red-600'};}else{return{text:'Junket Profit',icon:Trophy,color:'text-green-600'};}};// Show loading state\nif(loading){return/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center justify-center py-12\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto\"}),/*#__PURE__*/_jsx(\"p\",{className:\"mt-2 text-sm text-gray-600\",children:\"Loading real-time dashboard data from Supabase...\"})]})});}return/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-6\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"p-4 bg-green-50 border border-green-200 rounded-lg\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center\",children:[/*#__PURE__*/_jsx(Database,{className:\"w-5 h-5 text-green-600 mr-3\"}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-sm font-medium text-green-800\",children:\"\\u2705 Real-time Dashboard - Live Data from Supabase\"}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-xs text-green-600\",children:[\"Dashboard automatically updates every 30 seconds with live rolling amounts, customer data, and trip information.\",lastSyncTime&&\" \\u2022 Last sync: \".concat(lastSyncTime.toLocaleTimeString())]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-3\",children:[refreshing&&/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center text-blue-600\",children:[/*#__PURE__*/_jsx(Activity,{className:\"w-4 h-4 mr-1 animate-pulse\"}),/*#__PURE__*/_jsx(\"span\",{className:\"text-xs\",children:\"Syncing...\"})]}),/*#__PURE__*/_jsxs(Button,{variant:\"outline\",size:\"sm\",onClick:loadRealTimeData,disabled:refreshing,className:\"text-xs\",children:[/*#__PURE__*/_jsx(RefreshCw,{className:\"w-3 h-3 mr-1\"}),\"Refresh\"]}),/*#__PURE__*/_jsxs(Button,{variant:\"outline\",size:\"sm\",onClick:toggleRealTime,className:\"text-xs\",children:[/*#__PURE__*/_jsx(Zap,{className:\"w-3 h-3 mr-1 \".concat(isRealTimeEnabled?'text-green-500':'text-gray-500')}),isRealTimeEnabled?'Live':'Manual']}),/*#__PURE__*/_jsxs(Badge,{variant:\"outline\",className:\"text-xs \".concat(connectionStatus==='connected'?'bg-green-50 text-green-700':'bg-red-50 text-red-700'),children:[/*#__PURE__*/_jsx(\"div\",{className:\"w-2 h-2 rounded-full mr-1 \".concat(connectionStatus==='connected'?'bg-green-500 animate-pulse':'bg-red-500')}),connectionStatus==='connected'?'Connected':'Error']})]})]})}),errorMessage&&/*#__PURE__*/_jsxs(Alert,{className:\"border-red-200 bg-red-50\",children:[/*#__PURE__*/_jsx(AlertTriangle,{className:\"w-4 h-4 text-red-600\"}),/*#__PURE__*/_jsxs(AlertDescription,{className:\"text-red-800\",children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Connection Error:\"}),\" \",errorMessage,/*#__PURE__*/_jsxs(Button,{onClick:loadRealTimeData,size:\"sm\",variant:\"outline\",className:\"ml-3 text-red-800 border-red-300 hover:bg-red-100\",children:[/*#__PURE__*/_jsx(RefreshCw,{className:\"w-3 h-3 mr-1\"}),\"Retry\"]})]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-lg font-medium mb-4\",children:\"Real-time Financial Overview\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\",children:[/*#__PURE__*/_jsxs(Card,{className:\"bg-gradient-to-r from-blue-50 to-blue-100 border-blue-200\",children:[/*#__PURE__*/_jsxs(CardHeader,{className:\"flex flex-row items-center justify-between space-y-0 pb-2\",children:[/*#__PURE__*/_jsx(CardTitle,{className:\"text-sm font-medium text-blue-800\",children:\"Total Rolling Amount\"}),/*#__PURE__*/_jsx(DollarSign,{className:\"h-4 w-4 text-blue-600\"})]}),/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsxs(\"div\",{className:\"text-2xl font-bold text-blue-700\",children:[\"HK$\",safeFormatNumber(metrics.customerTotalRolling)]}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-xs text-blue-600\",children:[\"From \",metrics.totalRollingRecords,\" rolling records across \",metrics.totalCustomers,\" customers\"]})]})]}),/*#__PURE__*/_jsxs(Card,{className:\"bg-gradient-to-r \".concat(metrics.houseGrossWin>=0?'from-green-50 to-green-100 border-green-200':'from-red-50 to-red-100 border-red-200'),children:[/*#__PURE__*/_jsxs(CardHeader,{className:\"flex flex-row items-center justify-between space-y-0 pb-2\",children:[/*#__PURE__*/_jsx(CardTitle,{className:\"text-sm font-medium \".concat(metrics.houseGrossWin>=0?'text-green-800':'text-red-800'),children:\"Company Gross Profit\"}),metrics.houseGrossWin>=0?/*#__PURE__*/_jsx(Trophy,{className:\"h-4 w-4 text-green-600\"}):/*#__PURE__*/_jsx(TrendingDown,{className:\"h-4 w-4 text-red-600\"})]}),/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsxs(\"div\",{className:\"text-2xl font-bold \".concat(metrics.houseGrossWin>=0?'text-green-600':'text-red-600'),children:[\"HK$\",safeFormatNumber(metrics.houseGrossWin)]}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs \".concat(metrics.houseGrossWin>=0?'text-green-600':'text-red-600'),children:\"From trip sharing win/loss data\"})]})]}),/*#__PURE__*/_jsxs(Card,{className:\"bg-gradient-to-r from-red-50 to-red-100 border-red-200\",children:[/*#__PURE__*/_jsxs(CardHeader,{className:\"flex flex-row items-center justify-between space-y-0 pb-2\",children:[/*#__PURE__*/_jsx(CardTitle,{className:\"text-sm font-medium text-red-800\",children:\"Expenses\"}),/*#__PURE__*/_jsx(Receipt,{className:\"h-4 w-4 text-red-600\"})]}),/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsxs(\"div\",{className:\"text-2xl font-bold text-red-700\",children:[\"HK$\",safeFormatNumber(metrics.totalExpenses)]}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-red-600\",children:\"Total operational expenses from trip sharing\"})]})]}),/*#__PURE__*/_jsxs(Card,{className:\"bg-gradient-to-r \".concat(metrics.houseFinalProfit>=0?'from-green-50 to-green-100 border-green-200':'from-red-50 to-red-100 border-red-200'),children:[/*#__PURE__*/_jsxs(CardHeader,{className:\"flex flex-row items-center justify-between space-y-0 pb-2\",children:[/*#__PURE__*/_jsx(CardTitle,{className:\"text-sm font-medium \".concat(metrics.houseFinalProfit>=0?'text-green-800':'text-red-800'),children:\"Company Net Profit\"}),metrics.houseFinalProfit>=0?/*#__PURE__*/_jsx(Trophy,{className:\"h-4 w-4 text-green-600\"}):/*#__PURE__*/_jsx(TrendingDown,{className:\"h-4 w-4 text-red-600\"})]}),/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsxs(\"div\",{className:\"text-2xl font-bold \".concat(metrics.houseFinalProfit>=0?'text-green-600':'text-red-600'),children:[\"HK$\",safeFormatNumber(metrics.houseFinalProfit)]}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs \".concat(metrics.houseFinalProfit>=0?'text-green-600':'text-red-600'),children:\"Company share from trip sharing\"})]})]})]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-lg font-medium mb-4\",children:\"Operations Overview\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\",children:[/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(CardHeader,{className:\"flex flex-row items-center justify-between space-y-0 pb-2\",children:[/*#__PURE__*/_jsx(CardTitle,{className:\"text-sm font-medium\",children:\"Active Customers\"}),/*#__PURE__*/_jsx(Users,{className:\"h-4 w-4 text-muted-foreground\"})]}),/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-2xl font-bold\",children:metrics.activeCustomers}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-xs text-muted-foreground\",children:[\"of \",metrics.totalCustomers,\" total customers\"]})]})]}),/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(CardHeader,{className:\"flex flex-row items-center justify-between space-y-0 pb-2\",children:[/*#__PURE__*/_jsx(CardTitle,{className:\"text-sm font-medium\",children:\"Active Agents\"}),/*#__PURE__*/_jsx(UserCheck,{className:\"h-4 w-4 text-muted-foreground\"})]}),/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-2xl font-bold\",children:metrics.activeAgents}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-xs text-muted-foreground\",children:[\"of \",metrics.totalAgents,\" total agents\"]})]})]}),/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(CardHeader,{className:\"flex flex-row items-center justify-between space-y-0 pb-2\",children:[/*#__PURE__*/_jsx(CardTitle,{className:\"text-sm font-medium\",children:\"Trip Summary\"}),/*#__PURE__*/_jsx(MapPin,{className:\"h-4 w-4 text-muted-foreground\"})]}),/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-2xl font-bold\",children:metrics.totalTrips}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-xs text-muted-foreground\",children:[metrics.completedTrips,\" completed, \",metrics.ongoingTrips,\" ongoing, \",metrics.plannedTrips,\" planned\"]})]})]}),/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(CardHeader,{className:\"flex flex-row items-center justify-between space-y-0 pb-2\",children:[/*#__PURE__*/_jsx(CardTitle,{className:\"text-sm font-medium\",children:\"Recent Activity\"}),/*#__PURE__*/_jsx(Activity,{className:\"h-4 w-4 text-muted-foreground\"})]}),/*#__PURE__*/_jsxs(CardContent,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-2xl font-bold\",children:metrics.recentRollingRecords+metrics.recentBuyInOutRecords}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-muted-foreground\",children:\"Transactions in last 24 hours\"})]})]})]})]}),/*#__PURE__*/_jsxs(Card,{className:\"h-full\",children:[/*#__PURE__*/_jsxs(CardHeader,{children:[/*#__PURE__*/_jsx(CardTitle,{children:\"Active Trips\"}),/*#__PURE__*/_jsx(CardDescription,{children:\"Current ongoing trips with real-time performance data\"})]}),/*#__PURE__*/_jsx(CardContent,{children:activeTrips.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"text-center py-8\",children:[/*#__PURE__*/_jsx(MapPin,{className:\"h-12 w-12 text-gray-300 mx-auto mb-3\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500\",children:\"No active trips found\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-gray-400 mt-1\",children:\"Active trips will appear here when trips are in progress\"})]}):/*#__PURE__*/_jsx(\"div\",{className:\"space-y-4\",children:activeTrips.slice(0,5)// Show up to 5 trips to match customer performance section\n.map(trip=>{var _trip$sharing11,_trip$sharing12,_trip$sharing13,_trip$sharing14,_trip$customers2;// Use trip_sharing data directly\nconst totalRolling=Math.abs(((_trip$sharing11=trip.sharing)===null||_trip$sharing11===void 0?void 0:_trip$sharing11.total_rolling)||((_trip$sharing12=trip.sharing)===null||_trip$sharing12===void 0?void 0:_trip$sharing12.totalRolling)||0);const winLoss=((_trip$sharing13=trip.sharing)===null||_trip$sharing13===void 0?void 0:_trip$sharing13.total_win_loss)||((_trip$sharing14=trip.sharing)===null||_trip$sharing14===void 0?void 0:_trip$sharing14.totalWinLoss)||0;// Calculate progress based on dates\nconst startDate=trip.start_date?new Date(trip.start_date):null;const endDate=trip.end_date?new Date(trip.end_date):null;const now=new Date();let progress=0;if(startDate&&endDate){const totalDuration=endDate.getTime()-startDate.getTime();const elapsed=now.getTime()-startDate.getTime();progress=Math.max(0,Math.min(100,elapsed/totalDuration*100));}return/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition-colors\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-4\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex-shrink-0\",children:/*#__PURE__*/_jsx(Badge,{variant:\"secondary\",className:\"bg-green-100 text-green-700 border-green-200\",children:trip.status==='active'?'Active':'Ongoing'})}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"p\",{className:\"font-medium\",children:trip.trip_name||trip.name||'Unnamed Trip'}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-sm text-gray-500 flex items-center\",children:[/*#__PURE__*/_jsx(MapPin,{className:\"h-3 w-3 mr-1\"}),trip.destination||'Unknown Destination',\" \\u2022 \",((_trip$customers2=trip.customers)===null||_trip$customers2===void 0?void 0:_trip$customers2.length)||0,\" customers\"]}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-xs text-blue-600\",children:[\"Progress: \",Math.round(progress),\"% \\u2022 \",trip.start_date?new Date(trip.start_date).toLocaleDateString():'TBD',\" - \",trip.end_date?new Date(trip.end_date).toLocaleDateString():'TBD']})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-2 gap-6 text-right text-xs\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-gray-500\",children:\"Rolling\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"font-medium text-blue-600\",children:[\"HK$\",safeFormatNumber(totalRolling)]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-gray-500\",children:\"Win/Loss\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"font-medium \".concat(winLoss<=0?'text-green-600':'text-red-600'),children:[\"HK$\",safeFormatNumber(Math.abs(winLoss))]})]})]})]},trip.id);})})})]}),/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(CardHeader,{children:[/*#__PURE__*/_jsx(CardTitle,{children:\"Real-time Customer Performance\"}),/*#__PURE__*/_jsxs(CardDescription,{children:[\"Top performing customers based on live rolling data \",user.role==='agent'?'you manage':'']})]}),/*#__PURE__*/_jsx(CardContent,{children:filteredCustomers.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"text-center py-8\",children:[/*#__PURE__*/_jsx(Users,{className:\"h-12 w-12 text-gray-300 mx-auto mb-3\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500\",children:\"No customer data found\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-gray-400 mt-1\",children:\"Customer performance will appear here once rolling records are created\"})]}):/*#__PURE__*/_jsx(\"div\",{className:\"space-y-4\",children:filteredCustomers.sort((a,b)=>safeNumber(b.totalRolling)-safeNumber(a.totalRolling)).slice(0,5).map(customer=>{const indicator=getWinLossStatus(customer.totalWinLoss||0);const Icon=indicator.icon;const commission=(customer.totalRolling||0)*((customer.rollingPercentage||0)/100);return/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition-colors\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-4\",children:[/*#__PURE__*/_jsx(Icon,{className:\"h-5 w-5 \".concat(indicator.color)}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"p\",{className:\"font-medium\",children:customer.name}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-sm text-gray-500\",children:[\"Agent: \",customer.agentName,\" \\u2022 \",customer.isActive?'Active':'Inactive']}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-xs text-purple-600\",children:[\"Commission Rate: \",customer.rollingPercentage,\"%\"]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-2 gap-6 text-right text-xs\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-gray-500\",children:\"Rolling\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"font-medium text-blue-600\",children:[\"HK$\",safeFormatNumber(Math.abs(customer.totalRolling||0))]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-gray-500\",children:\"Win/Loss\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"font-medium \".concat((customer.totalWinLoss||0)<=0?'text-green-600':'text-red-600'),children:[\"HK$\",safeFormatNumber(Math.abs(customer.totalWinLoss||0))]})]})]})]},customer.id);})})})]})]});}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}