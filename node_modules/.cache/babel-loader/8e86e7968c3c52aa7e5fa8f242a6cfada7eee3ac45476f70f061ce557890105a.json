{"ast":null,"code":"import React,{useState,useEffect}from'react';import{LoginForm}from'./components/LoginForm';import{Dashboard}from'./components/Dashboard';import{CustomerManagement}from'./components/CustomerManagement';import{AgentManagement}from'./components/AgentManagement';import{StaffManagement}from'./components/StaffManagement';import{StaffSelfService}from'./components/StaffSelfService';import ProjectManagement from'./components/ProjectManagement';import{DataManagement}from'./components/DataManagement';import{Button}from'./components/ui/button';import{LogOut,Users,UserCheck,BarChart3,MapPin,ShieldCheck,Clock,Database,Settings,AlertTriangle,CheckCircle,Wifi,RefreshCw,Bug,Shield}from'lucide-react';import{db}from'./utils/api/databaseWrapper';import{Badge}from'./components/ui/badge';import{LanguageProvider,useLanguage}from'./contexts/LanguageContext';import{LanguageToggle}from'./components/LanguageToggle';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";function AppContent(){const{t}=useLanguage();const[currentUser,setCurrentUser]=useState(null);const[activeTab,setActiveTab]=useState('dashboard');const[isDatabaseHealthy,setIsDatabaseHealthy]=useState(true);const[errorMessage,setErrorMessage]=useState('');const[isInitializing,setIsInitializing]=useState(true);const[connectionDetails,setConnectionDetails]=useState(null);const[debugMode,setDebugMode]=useState(false);useEffect(()=>{var _process$env$REACT_AP;initializeApplication();// Test API connection for Cloudflare Pages deployment\nfetch(\"\".concat((_process$env$REACT_AP=process.env.REACT_APP_API_URL)===null||_process$env$REACT_AP===void 0?void 0:_process$env$REACT_AP.replace('/api',''),\"/health\")).then(res=>res.json()).then(data=>{console.log('✅ Backend health check:',data);}).catch(error=>{console.error('❌ Backend health check failed:',error);});},[]);const initializeApplication=async()=>{setIsInitializing(true);setErrorMessage('');try{console.log('🚀 Initializing Casino Management System...');// Test connection with detailed feedback\nconst connectionTest=await db.testConnection();setConnectionDetails(connectionTest);if(!connectionTest.success){setIsDatabaseHealthy(false);throw new Error(\"Database connection failed: \".concat(connectionTest.message,\". \").concat(connectionTest.details||''));}// Check Supabase health\nconst isHealthy=await db.isHealthy();setIsDatabaseHealthy(isHealthy);if(!isHealthy){throw new Error('Supabase database health check failed. The server may be temporarily unavailable.');}// Safe initialization that preserves existing data\nconsole.log('🛡️ Performing safe database initialization...');await db.initializeSampleDataIfNeeded();// Check for saved user session\nconst savedUser=localStorage.getItem('casinoUser');if(savedUser){try{const user=JSON.parse(savedUser);setCurrentUser(user);console.log('👤 Restored user session:',user.username);// Restore token to API client if available\nif(user.token){const{apiClient}=await import('./utils/api/apiClient');apiClient.setToken(user.token);console.log('🔑 Token restored to API client');}// Set default tab based on user role\nif(user.role==='staff'){setActiveTab('checkinout');}else{setActiveTab('dashboard');}}catch(error){console.error('Error parsing saved user session:',error);localStorage.removeItem('casinoUser');}}console.log('✅ Application initialization completed');}catch(error){console.error('❌ Application initialization failed:',error);setErrorMessage(\"Initialization failed: \".concat(error instanceof Error?error.message:'Unknown error occurred'));setIsDatabaseHealthy(false);}finally{setIsInitializing(false);}};const handleLogin=async user=>{try{// Verify database health before allowing login\nconst isHealthy=await db.isHealthy();if(!isHealthy){throw new Error('Database is not available. Please try again later.');}console.log('🔍 App.handleLogin received user:',user);console.log('🔍 App.handleLogin user role:',user===null||user===void 0?void 0:user.role);console.log('🔍 App.handleLogin user token:',user!==null&&user!==void 0&&user.token?'Present':'Missing');// Use the user object directly from databaseWrapper.login (already has token and role)\nsetCurrentUser(user);// The user object is already saved to localStorage by databaseWrapper.login\n// Just verify it's there\nconst savedUser=localStorage.getItem('casinoUser');console.log('🔍 App.handleLogin localStorage user:',savedUser);// Set default tab based on user role\nif(user.role==='staff'){setActiveTab('checkinout');}else{setActiveTab('dashboard');}setErrorMessage('');console.log('👤 User logged in:',user.username,'Role:',user.role);}catch(error){console.error('❌ Login error:',error);setErrorMessage(\"Login failed: \".concat(error instanceof Error?error.message:'Unknown error occurred'));}};const handleLogout=async()=>{setCurrentUser(null);localStorage.removeItem('casinoUser');// Clear token from API client\ntry{const{apiClient}=await import('./utils/api/apiClient');apiClient.setToken('');console.log('🔑 Token cleared from API client');}catch(error){console.warn('Failed to clear token from API client:',error);}setActiveTab('dashboard');setErrorMessage('');console.log('👤 User logged out');};const refreshDatabaseHealth=async()=>{try{setIsInitializing(true);// Run full connection test\nconst connectionTest=await db.testConnection();setConnectionDetails(connectionTest);const isHealthy=await db.isHealthy();setIsDatabaseHealthy(isHealthy);if(isHealthy){setErrorMessage('');console.log('✅ Database health check passed');}else{setErrorMessage('Database connection issues detected. Some features may not work properly.');console.warn('⚠️ Database health check failed');}}catch(error){console.error('❌ Database health check error:',error);setIsDatabaseHealthy(false);setErrorMessage(\"Database error: \".concat(error instanceof Error?error.message:'Unknown error occurred'));}finally{setIsInitializing(false);}};// Show loading screen during initialization\nif(isInitializing){return/*#__PURE__*/_jsx(\"div\",{className:\"min-h-screen bg-gray-50 flex items-center justify-center\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"text-center max-w-md\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4\"}),/*#__PURE__*/_jsx(\"h2\",{className:\"text-lg font-medium text-gray-900 mb-2\",children:\"Initializing Casino Management System\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-600 mb-4\",children:\"Connecting to Supabase database with data preservation...\"}),connectionDetails&&/*#__PURE__*/_jsxs(\"div\",{className:\"mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-left\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2 mb-2\",children:[/*#__PURE__*/_jsx(Database,{className:\"w-4 h-4 text-blue-600\"}),/*#__PURE__*/_jsx(\"span\",{className:\"text-sm font-medium text-blue-800\",children:\"Connection Status\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"text-xs text-blue-700 space-y-1\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[\"Status: \",connectionDetails.success?'✅ Connected':'❌ Failed']}),/*#__PURE__*/_jsxs(\"div\",{children:[\"Message: \",connectionDetails.message]}),connectionDetails.details&&/*#__PURE__*/_jsxs(\"div\",{children:[\"Details: \",connectionDetails.details]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2 mb-2\",children:[/*#__PURE__*/_jsx(Shield,{className:\"w-4 h-4 text-green-600\"}),/*#__PURE__*/_jsx(\"span\",{className:\"text-sm font-medium text-green-800\",children:\"Data Protection\"})]}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-green-700\",children:\"Your existing data is safe. The system will not clear any entered information during initialization.\"})]})]})});}if(!currentUser){return/*#__PURE__*/_jsxs(\"div\",{children:[errorMessage&&/*#__PURE__*/_jsx(\"div\",{className:\"bg-red-50 border-l-4 border-red-400 p-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex-shrink-0\",children:/*#__PURE__*/_jsx(AlertTriangle,{className:\"h-5 w-5 text-red-400\"})}),/*#__PURE__*/_jsxs(\"div\",{className:\"ml-3\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-sm font-medium text-red-800\",children:\"Database Connection Error\"}),/*#__PURE__*/_jsx(\"div\",{className:\"mt-2 text-sm text-red-700\",children:/*#__PURE__*/_jsx(\"p\",{children:errorMessage})}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-4 flex space-x-2\",children:[/*#__PURE__*/_jsxs(Button,{onClick:refreshDatabaseHealth,size:\"sm\",variant:\"outline\",className:\"text-red-800 border-red-300 hover:bg-red-100\",children:[/*#__PURE__*/_jsx(RefreshCw,{className:\"w-4 h-4 mr-2\"}),\"Retry Connection\"]}),/*#__PURE__*/_jsxs(Button,{onClick:()=>setDebugMode(!debugMode),size:\"sm\",variant:\"outline\",className:\"text-red-800 border-red-300 hover:bg-red-100\",children:[/*#__PURE__*/_jsx(Bug,{className:\"w-4 h-4 mr-2\"}),debugMode?'Hide':'Show',\" Debug Info\"]})]}),debugMode&&connectionDetails&&/*#__PURE__*/_jsx(\"div\",{className:\"mt-3 p-2 bg-red-100 rounded text-xs\",children:/*#__PURE__*/_jsx(\"pre\",{className:\"text-red-800\",children:JSON.stringify(connectionDetails,null,2)})})]})]})}),/*#__PURE__*/_jsx(LoginForm,{onLogin:handleLogin})]});}const isAdmin=(currentUser===null||currentUser===void 0?void 0:currentUser.role)==='admin';const isAgent=(currentUser===null||currentUser===void 0?void 0:currentUser.role)==='agent';const isStaff=(currentUser===null||currentUser===void 0?void 0:currentUser.role)==='staff';const isBoss=(currentUser===null||currentUser===void 0?void 0:currentUser.role)==='boss';// Helper function to get display role\nconst getDisplayRole=()=>{var _currentUser$role;return currentUser===null||currentUser===void 0?void 0:(_currentUser$role=currentUser.role)===null||_currentUser$role===void 0?void 0:_currentUser$role.toUpperCase();};return/*#__PURE__*/_jsxs(\"div\",{className:\"min-h-screen bg-gray-50\",children:[/*#__PURE__*/_jsx(\"header\",{className:\"bg-white shadow-sm border-b\",children:/*#__PURE__*/_jsx(\"div\",{className:\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between items-center h-16\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-4\",children:[/*#__PURE__*/_jsx(\"h1\",{className:\"text-xl font-semibold text-gray-900\",children:\"Casino Management System\"}),/*#__PURE__*/_jsx(Badge,{variant:\"secondary\",className:\"text-xs\",children:getDisplayRole()}),/*#__PURE__*/_jsxs(Badge,{variant:\"default\",className:\"text-xs flex items-center gap-1\",children:[/*#__PURE__*/_jsx(Database,{className:\"w-3 h-3\"}),\"Supabase\"]}),/*#__PURE__*/_jsx(Badge,{variant:\"outline\",className:\"text-xs flex items-center gap-1 \".concat(isDatabaseHealthy?'border-green-200 text-green-700':'border-red-200 text-red-700'),children:isDatabaseHealthy?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(CheckCircle,{className:\"w-3 h-3\"}),\"Connected\"]}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(AlertTriangle,{className:\"w-3 h-3\"}),\"Issues\"]})}),/*#__PURE__*/_jsxs(Badge,{variant:\"outline\",className:\"text-xs flex items-center gap-1 border-blue-200 text-blue-700\",children:[/*#__PURE__*/_jsx(Shield,{className:\"w-3 h-3\"}),\"Data Protected\"]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-4\",children:[/*#__PURE__*/_jsx(LanguageToggle,{}),!isDatabaseHealthy&&/*#__PURE__*/_jsxs(Button,{variant:\"outline\",size:\"sm\",onClick:refreshDatabaseHealth,className:\"text-xs\",children:[/*#__PURE__*/_jsx(Wifi,{className:\"w-4 h-4 mr-2\"}),\"Reconnect\"]}),/*#__PURE__*/_jsxs(\"span\",{className:\"text-sm text-gray-600\",children:[\"Welcome, \",currentUser.username]}),/*#__PURE__*/_jsxs(Button,{variant:\"outline\",size:\"sm\",onClick:handleLogout,children:[/*#__PURE__*/_jsx(LogOut,{className:\"w-4 h-4 mr-2\"}),\"Logout\"]})]})]})})}),/*#__PURE__*/_jsxs(\"div\",{className:\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-wrap space-x-1 mb-8 bg-gray-100 p-1 rounded-lg\",children:[(isAdmin||isAgent||isBoss)&&/*#__PURE__*/_jsxs(\"button\",{onClick:()=>setActiveTab('dashboard'),className:\"flex items-center px-4 py-2 rounded-md text-sm font-medium transition-colors \".concat(activeTab==='dashboard'?'bg-white text-gray-900 shadow-sm':'text-gray-600 hover:text-gray-900'),children:[/*#__PURE__*/_jsx(BarChart3,{className:\"w-4 h-4 mr-2\"}),t('dashboard')]}),isStaff&&/*#__PURE__*/_jsxs(\"button\",{onClick:()=>setActiveTab('checkinout'),className:\"flex items-center px-4 py-2 rounded-md text-sm font-medium transition-colors \".concat(activeTab==='checkinout'?'bg-white text-gray-900 shadow-sm':'text-gray-600 hover:text-gray-900'),children:[/*#__PURE__*/_jsx(Clock,{className:\"w-4 h-4 mr-2\"}),t('checkinout')]}),(isAdmin||isAgent||isStaff||isBoss)&&/*#__PURE__*/_jsxs(\"button\",{onClick:()=>setActiveTab('customers'),className:\"flex items-center px-4 py-2 rounded-md text-sm font-medium transition-colors \".concat(activeTab==='customers'?'bg-white text-gray-900 shadow-sm':'text-gray-600 hover:text-gray-900'),children:[/*#__PURE__*/_jsx(Users,{className:\"w-4 h-4 mr-2\"}),t('customers'),\" \",(isStaff||isBoss)&&/*#__PURE__*/_jsx(\"span\",{className:\"ml-1 text-xs text-gray-500\",children:\"(View)\"})]}),(isAdmin||isStaff||isBoss)&&/*#__PURE__*/_jsxs(\"button\",{onClick:()=>setActiveTab('agents'),className:\"flex items-center px-4 py-2 rounded-md text-sm font-medium transition-colors \".concat(activeTab==='agents'?'bg-white text-gray-900 shadow-sm':'text-gray-600 hover:text-gray-900'),children:[/*#__PURE__*/_jsx(UserCheck,{className:\"w-4 h-4 mr-2\"}),t('agents'),\" \",(isStaff||isBoss)&&/*#__PURE__*/_jsx(\"span\",{className:\"ml-1 text-xs text-gray-500\",children:\"(View)\"})]}),(isAdmin||isBoss)&&/*#__PURE__*/_jsxs(\"button\",{onClick:()=>setActiveTab('staff'),className:\"flex items-center px-4 py-2 rounded-md text-sm font-medium transition-colors \".concat(activeTab==='staff'?'bg-white text-gray-900 shadow-sm':'text-gray-600 hover:text-gray-900'),children:[/*#__PURE__*/_jsx(ShieldCheck,{className:\"w-4 h-4 mr-2\"}),t('staff')]}),(isAdmin||isAgent||isBoss)&&/*#__PURE__*/_jsxs(\"button\",{onClick:()=>setActiveTab('projects'),className:\"flex items-center px-4 py-2 rounded-md text-sm font-medium transition-colors \".concat(activeTab==='projects'?'bg-white text-gray-900 shadow-sm':'text-gray-600 hover:text-gray-900'),children:[/*#__PURE__*/_jsx(MapPin,{className:\"w-4 h-4 mr-2\"}),t('projects')]}),(isAdmin||isBoss)&&/*#__PURE__*/_jsxs(\"button\",{onClick:()=>setActiveTab('data'),className:\"flex items-center px-4 py-2 rounded-md text-sm font-medium transition-colors \".concat(activeTab==='data'?'bg-white text-gray-900 shadow-sm':'text-gray-600 hover:text-gray-900'),children:[/*#__PURE__*/_jsx(Settings,{className:\"w-4 h-4 mr-2\"}),t('data')]})]}),activeTab==='dashboard'&&/*#__PURE__*/_jsx(Dashboard,{user:currentUser}),activeTab==='customers'&&(isAdmin||isAgent||isStaff||isBoss)&&/*#__PURE__*/_jsx(CustomerManagement,{user:currentUser,showError:()=>{},clearError:()=>{}}),activeTab==='agents'&&(isAdmin||isStaff||isBoss)&&/*#__PURE__*/_jsx(AgentManagement,{user:currentUser,showError:()=>{},clearError:()=>{}}),activeTab==='staff'&&(isAdmin||isBoss)&&/*#__PURE__*/_jsx(StaffManagement,{user:currentUser,showError:()=>{},clearError:()=>{}}),activeTab==='checkinout'&&isStaff&&/*#__PURE__*/_jsx(StaffSelfService,{user:currentUser,showError:()=>{},clearError:()=>{}}),activeTab==='projects'&&(isAdmin||isAgent||isBoss)&&/*#__PURE__*/_jsx(ProjectManagement,{user:currentUser}),activeTab==='data'&&(isAdmin||isBoss)&&/*#__PURE__*/_jsx(DataManagement,{user:currentUser})]})]});}function App(){return/*#__PURE__*/_jsx(LanguageProvider,{children:/*#__PURE__*/_jsx(AppContent,{})});}export default App;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}