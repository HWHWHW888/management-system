{"ast":null,"code":"import React,{useState,useEffect,useCallback}from'react';import{Button}from'./ui/button';import{Input}from'./ui/input';import{Label}from'./ui/label';import{Card,CardContent,CardDescription,CardHeader,CardTitle}from'./ui/card';import{Dialog,DialogContent,DialogDescription,DialogHeader,DialogTitle,DialogTrigger}from'./ui/dialog';import{Badge}from'./ui/badge';import{Textarea}from'./ui/textarea';import{Tabs,TabsContent,TabsList,TabsTrigger}from'./ui/tabs';import{Clock,CheckCircle,XCircle,RefreshCw,LogIn,LogOut,Activity,Calendar,MapPin,Users}from'lucide-react';import{ImageWithFallback}from'./figma/ImageWithFallback';import{withErrorHandler}from'./withErrorHandler';import{apiClient}from'../utils/api/apiClient';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";function StaffSelfServiceComponent(_ref){let{user,showError,clearError}=_ref;const[currentStaff,setCurrentStaff]=useState(null);const[shifts,setShifts]=useState([]);const[assignedTrips,setAssignedTrips]=useState([]);const[isCheckInDialogOpen,setIsCheckInDialogOpen]=useState(false);const[isCheckOutDialogOpen,setIsCheckOutDialogOpen]=useState(false);const[checkInPhoto,setCheckInPhoto]=useState(null);const[checkOutPhoto,setCheckOutPhoto]=useState(null);const[checkInNotes,setCheckInNotes]=useState('');const[checkOutNotes,setCheckOutNotes]=useState('');const[isLoading,setIsLoading]=useState(true);const[isSaving,setIsSaving]=useState(false);// Load staff data and shifts\nconst loadStaffData=useCallback(async()=>{try{setIsLoading(true);clearError();// Get current staff info\nconst staffResponse=await apiClient.get(\"/staffs/\".concat(user.id));if(staffResponse.success){setCurrentStaff(staffResponse.data);}// Get staff shifts history\nconst shiftsResponse=await apiClient.get(\"/staffs/\".concat(user.id,\"/shifts\"));if(shiftsResponse.success){setShifts(shiftsResponse.data);}// Get assigned trips (staff can only see their assigned trips)\nconst tripsResponse=await apiClient.get('/trips/my-schedule');if(tripsResponse.success){setAssignedTrips(tripsResponse.data);}}catch(error){console.error('Error loading staff data:',error);showError('Failed to load staff data');}finally{setIsLoading(false);}},[user.id,clearError,showError]);useEffect(()=>{loadStaffData();},[loadStaffData]);const getCurrentShift=()=>{return shifts.find(shift=>shift.status==='checked-in');};const isCheckedIn=()=>{return getCurrentShift()!==undefined;};const handleCheckIn=async()=>{if(!checkInPhoto)return;setIsSaving(true);try{// Convert photo to base64\nconst reader=new FileReader();reader.onload=async e=>{try{var _e$target;const photoData=(_e$target=e.target)===null||_e$target===void 0?void 0:_e$target.result;const response=await apiClient.post(\"/staffs/\".concat(user.id,\"/check-in\"),{check_in_photo:photoData,notes:checkInNotes});if(response.success){setIsCheckInDialogOpen(false);setCheckInPhoto(null);setCheckInNotes('');await loadStaffData();// Refresh data\n}else{showError('Check-in failed: '+response.message);}}catch(error){console.error('Check-in error:',error);showError('Check-in failed');}finally{setIsSaving(false);}};reader.readAsDataURL(checkInPhoto);}catch(error){console.error('Check-in error:',error);showError('Check-in failed');setIsSaving(false);}};const handleCheckOut=async()=>{if(!checkOutPhoto)return;setIsSaving(true);try{const reader=new FileReader();reader.onload=async e=>{try{var _e$target2;const photoData=(_e$target2=e.target)===null||_e$target2===void 0?void 0:_e$target2.result;const response=await apiClient.post(\"/staffs/\".concat(user.id,\"/check-out\"),{check_out_photo:photoData,notes:checkOutNotes});if(response.success){setIsCheckOutDialogOpen(false);setCheckOutPhoto(null);setCheckOutNotes('');await loadStaffData();// Refresh data\n}else{showError('Check-out failed: '+response.message);}}catch(error){console.error('Check-out error:',error);showError('Check-out failed');}finally{setIsSaving(false);}};reader.readAsDataURL(checkOutPhoto);}catch(error){console.error('Check-out error:',error);showError('Check-out failed');setIsSaving(false);}};if(isLoading){return/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center justify-center h-64\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm text-gray-600\",children:\"Loading staff information...\"})]})});}const currentShift=getCurrentShift();return/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-6\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between items-center\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h2\",{className:\"text-2xl font-bold\",children:\"Staff Self-Service\"}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-gray-600\",children:[\"Welcome, \",(currentStaff===null||currentStaff===void 0?void 0:currentStaff.name)||user.username]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-4 mt-1\",children:[/*#__PURE__*/_jsxs(Badge,{variant:\"outline\",className:\"text-xs\",children:[\"Staff ID: \",user.id]}),/*#__PURE__*/_jsxs(Badge,{variant:\"outline\",className:\"text-xs\",children:[assignedTrips.length,\" Assigned Trips\"]})]})]}),/*#__PURE__*/_jsxs(Button,{variant:\"outline\",onClick:loadStaffData,disabled:isLoading,children:[/*#__PURE__*/_jsx(RefreshCw,{className:\"w-4 h-4 mr-2\"}),\"Refresh\"]})]}),/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsx(CardHeader,{children:/*#__PURE__*/_jsxs(CardTitle,{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(Clock,{className:\"w-5 h-5\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Current Status\"})]})}),/*#__PURE__*/_jsx(CardContent,{children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center space-x-4\",children:isCheckedIn()?/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col space-y-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsxs(Badge,{className:\"bg-green-100 text-green-800 px-3 py-1\",children:[/*#__PURE__*/_jsx(CheckCircle,{className:\"w-4 h-4 mr-1\"}),\"On Duty\"]}),/*#__PURE__*/_jsxs(\"span\",{className:\"text-sm text-gray-600\",children:[\"Since: \",new Date(currentShift.check_in_time).toLocaleString()]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"text-xs text-gray-500\",children:[\"Shift Date: \",currentShift.shift_date,\" | Duration: \",Math.floor((new Date().getTime()-new Date(currentShift.check_in_time).getTime())/(1000*60)),\" minutes\"]})]}):/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsxs(Badge,{variant:\"secondary\",className:\"px-3 py-1\",children:[/*#__PURE__*/_jsx(XCircle,{className:\"w-4 h-4 mr-1\"}),\"Off Duty\"]}),/*#__PURE__*/_jsx(\"span\",{className:\"text-sm text-gray-600\",children:\"Ready to check in\"})]})}),/*#__PURE__*/_jsx(\"div\",{className:\"flex space-x-2\",children:isCheckedIn()?/*#__PURE__*/_jsxs(Dialog,{open:isCheckOutDialogOpen,onOpenChange:setIsCheckOutDialogOpen,children:[/*#__PURE__*/_jsx(DialogTrigger,{asChild:true,children:/*#__PURE__*/_jsxs(Button,{variant:\"destructive\",disabled:isSaving,children:[/*#__PURE__*/_jsx(LogOut,{className:\"w-4 h-4 mr-2\"}),\"Check Out\"]})}),/*#__PURE__*/_jsxs(DialogContent,{children:[/*#__PURE__*/_jsxs(DialogHeader,{children:[/*#__PURE__*/_jsx(DialogTitle,{children:\"Check Out\"}),/*#__PURE__*/_jsx(DialogDescription,{children:\"Upload a photo as proof of check-out and add any end-of-shift notes.\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-4\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{htmlFor:\"checkOutPhoto\",children:\"Check-out Photo (Required)\"}),/*#__PURE__*/_jsx(Input,{id:\"checkOutPhoto\",type:\"file\",accept:\"image/*\",onChange:e=>{var _e$target$files;return setCheckOutPhoto(((_e$target$files=e.target.files)===null||_e$target$files===void 0?void 0:_e$target$files[0])||null);},className:\"mt-1\",required:true,disabled:isSaving})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{htmlFor:\"checkOutNotes\",children:\"End of Shift Notes (Optional)\"}),/*#__PURE__*/_jsx(Textarea,{id:\"checkOutNotes\",value:checkOutNotes,onChange:e=>setCheckOutNotes(e.target.value),placeholder:\"Any end-of-shift notes...\",rows:3,disabled:isSaving})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-end space-x-2\",children:[/*#__PURE__*/_jsx(Button,{type:\"button\",variant:\"outline\",onClick:()=>setIsCheckOutDialogOpen(false),disabled:isSaving,children:\"Cancel\"}),/*#__PURE__*/_jsx(Button,{onClick:handleCheckOut,disabled:!checkOutPhoto||isSaving,children:isSaving?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Activity,{className:\"w-4 h-4 mr-2 animate-spin\"}),\"Saving...\"]}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(LogOut,{className:\"w-4 h-4 mr-2\"}),\"Check Out\"]})})]})]})]})]}):/*#__PURE__*/_jsxs(Dialog,{open:isCheckInDialogOpen,onOpenChange:setIsCheckInDialogOpen,children:[/*#__PURE__*/_jsx(DialogTrigger,{asChild:true,children:/*#__PURE__*/_jsxs(Button,{disabled:isSaving,children:[/*#__PURE__*/_jsx(LogIn,{className:\"w-4 h-4 mr-2\"}),\"Check In\"]})}),/*#__PURE__*/_jsxs(DialogContent,{children:[/*#__PURE__*/_jsxs(DialogHeader,{children:[/*#__PURE__*/_jsx(DialogTitle,{children:\"Check In\"}),/*#__PURE__*/_jsx(DialogDescription,{children:\"Upload a photo as proof of check-in and add any notes for the shift.\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-4\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{htmlFor:\"checkInPhoto\",children:\"Check-in Photo (Required)\"}),/*#__PURE__*/_jsx(Input,{id:\"checkInPhoto\",type:\"file\",accept:\"image/*\",onChange:e=>{var _e$target$files2;return setCheckInPhoto(((_e$target$files2=e.target.files)===null||_e$target$files2===void 0?void 0:_e$target$files2[0])||null);},className:\"mt-1\",required:true,disabled:isSaving})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{htmlFor:\"checkInNotes\",children:\"Notes (Optional)\"}),/*#__PURE__*/_jsx(Textarea,{id:\"checkInNotes\",value:checkInNotes,onChange:e=>setCheckInNotes(e.target.value),placeholder:\"Any notes for this shift...\",rows:3,disabled:isSaving})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-end space-x-2\",children:[/*#__PURE__*/_jsx(Button,{type:\"button\",variant:\"outline\",onClick:()=>setIsCheckInDialogOpen(false),disabled:isSaving,children:\"Cancel\"}),/*#__PURE__*/_jsx(Button,{onClick:handleCheckIn,disabled:!checkInPhoto||isSaving,children:isSaving?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Activity,{className:\"w-4 h-4 mr-2 animate-spin\"}),\"Saving...\"]}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(LogIn,{className:\"w-4 h-4 mr-2\"}),\"Check In\"]})})]})]})]})]})})]})})]}),/*#__PURE__*/_jsxs(Tabs,{defaultValue:\"trips\",className:\"w-full\",children:[/*#__PURE__*/_jsxs(TabsList,{className:\"grid w-full grid-cols-2\",children:[/*#__PURE__*/_jsxs(TabsTrigger,{value:\"trips\",className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(MapPin,{className:\"w-4 h-4\"}),/*#__PURE__*/_jsx(\"span\",{children:\"My Trips\"})]}),/*#__PURE__*/_jsxs(TabsTrigger,{value:\"shifts\",className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(Calendar,{className:\"w-4 h-4\"}),/*#__PURE__*/_jsx(\"span\",{children:\"My Shifts\"})]})]}),/*#__PURE__*/_jsx(TabsContent,{value:\"trips\",className:\"mt-6\",children:/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(CardHeader,{children:[/*#__PURE__*/_jsxs(CardTitle,{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(MapPin,{className:\"w-5 h-5\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Assigned Trips\"})]}),/*#__PURE__*/_jsx(CardDescription,{children:\"Trips you are assigned to manage\"})]}),/*#__PURE__*/_jsx(CardContent,{children:assignedTrips.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"text-center py-8\",children:[/*#__PURE__*/_jsx(Users,{className:\"w-12 h-12 mx-auto text-gray-400 mb-4\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500\",children:\"No trips assigned.\"})]}):/*#__PURE__*/_jsx(\"div\",{className:\"space-y-4\",children:assignedTrips.map(trip=>/*#__PURE__*/_jsx(Card,{className:\"border-l-4 border-l-blue-400\",children:/*#__PURE__*/_jsxs(CardContent,{className:\"p-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between mb-2\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center space-x-2\",children:/*#__PURE__*/_jsx(\"h4\",{className:\"font-medium\",children:trip.trip_name})}),/*#__PURE__*/_jsx(Badge,{className:trip.status==='active'?'bg-green-100 text-green-800':trip.status==='in-progress'?'bg-blue-100 text-blue-800':'bg-gray-100 text-gray-800',children:trip.status})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-2 gap-4 text-sm\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{className:\"text-xs text-gray-500\",children:\"Destination\"}),/*#__PURE__*/_jsx(\"p\",{children:trip.destination})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{className:\"text-xs text-gray-500\",children:\"Dates\"}),/*#__PURE__*/_jsxs(\"p\",{children:[new Date(trip.start_date).toLocaleDateString(),\" - \",new Date(trip.end_date).toLocaleDateString()]})]})]}),trip.activecustomerscount>0&&/*#__PURE__*/_jsx(\"div\",{className:\"mt-2\",children:/*#__PURE__*/_jsxs(Badge,{variant:\"outline\",className:\"text-xs\",children:[trip.activecustomerscount,\" Active Customers\"]})})]})},trip.id))})})]})}),/*#__PURE__*/_jsx(TabsContent,{value:\"shifts\",className:\"mt-6\",children:/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(CardHeader,{children:[/*#__PURE__*/_jsxs(CardTitle,{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(Calendar,{className:\"w-5 h-5\"}),/*#__PURE__*/_jsx(\"span\",{children:\"Shift History\"})]}),/*#__PURE__*/_jsx(CardDescription,{children:\"Your recent shifts and attendance\"})]}),/*#__PURE__*/_jsx(CardContent,{children:shifts.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"text-center py-8\",children:[/*#__PURE__*/_jsx(Clock,{className:\"w-12 h-12 mx-auto text-gray-400 mb-4\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500\",children:\"No shift history found.\"})]}):/*#__PURE__*/_jsx(\"div\",{className:\"space-y-4\",children:shifts.slice(0,10).map(shift=>/*#__PURE__*/_jsx(Card,{className:\"border-l-4 border-l-blue-400\",children:/*#__PURE__*/_jsxs(CardContent,{className:\"p-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between mb-2\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(Calendar,{className:\"w-4 h-4 text-gray-400\"}),/*#__PURE__*/_jsx(\"span\",{className:\"font-medium\",children:shift.shift_date})]}),/*#__PURE__*/_jsx(Badge,{className:shift.status==='checked-in'?'bg-green-100 text-green-800':'bg-gray-100 text-gray-800',children:shift.status==='checked-in'?'On Duty':'Completed'})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{className:\"text-xs text-gray-500\",children:\"Check-in Time\"}),/*#__PURE__*/_jsx(\"p\",{children:new Date(shift.check_in_time).toLocaleString()}),shift.check_in_photo&&/*#__PURE__*/_jsx(\"div\",{className:\"mt-2\",children:/*#__PURE__*/_jsx(ImageWithFallback,{src:shift.check_in_photo,alt:\"Check-in proof\",className:\"w-16 h-16 object-cover rounded border\"})})]}),shift.check_out_time&&/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Label,{className:\"text-xs text-gray-500\",children:\"Check-out Time\"}),/*#__PURE__*/_jsx(\"p\",{children:new Date(shift.check_out_time).toLocaleString()}),shift.check_out_photo&&/*#__PURE__*/_jsx(\"div\",{className:\"mt-2\",children:/*#__PURE__*/_jsx(ImageWithFallback,{src:shift.check_out_photo,alt:\"Check-out proof\",className:\"w-16 h-16 object-cover rounded border\"})})]})]}),shift.notes&&/*#__PURE__*/_jsxs(\"div\",{className:\"mt-3 p-2 bg-gray-50 rounded text-xs\",children:[/*#__PURE__*/_jsx(Label,{className:\"text-gray-500\",children:\"Notes\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-700 mt-1\",children:shift.notes})]})]})},shift.id))})})]})})]})]});}export const StaffSelfService=withErrorHandler(StaffSelfServiceComponent);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}